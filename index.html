<!DOCTYPE html>
<html lang="fr" dir="ltr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Molino Pro - V9.1 (Avec vitesses moyennes)</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

    <style>
        body { font-family: 'Cairo', sans-serif; background-color: #f1f5f9; } 
        .tab-content { display: none; animation: fadeIn 0.4s ease-out; }
        .tab-content.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .loader { border: 3px solid #e2e8f0; border-top: 3px solid #3b82f6; border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite; display: inline-block; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .gauge-bar { transition: width 1s cubic-bezier(0.4, 0, 0.2, 1); }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .unreliable { opacity: 0.6; }
    </style>
</head>
<body class="bg-slate-100 text-slate-800 min-h-screen">

    <div id="auth-view" class="fixed inset-0 bg-slate-900 z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl p-8 w-full max-w-md text-center">
            <h1 class="text-3xl font-bold text-blue-600 mb-2">Molino <span class="text-slate-700">Pro</span></h1>
            <p class="text-gray-500 mb-6">Système de gestion intelligent</p>
            <form id="authForm" class="space-y-4">
                <input type="email" id="emailInput" placeholder="Email" required class="w-full p-3 border rounded-lg">
                <input type="password" id="passwordInput" placeholder="Mot de passe" required class="w-full p-3 border rounded-lg">
                <div id="authMessage" class="hidden p-2 rounded text-sm font-bold"></div>
                <button type="submit" id="authBtn" class="w-full bg-blue-600 text-white font-bold py-3 rounded-lg">Entrer</button>
            </form>
            <p class="mt-4 text-sm text-gray-500 cursor-pointer" onclick="toggleAuthMode()">Basculer (Connexion / Inscription)</p>
        </div>
    </div>

    <div id="app-view" class="hidden">
        
        <header class="bg-white shadow-sm sticky top-0 z-40">
            <div class="max-w-7xl mx-auto px-4 py-3 flex justify-between items-center">
                <div class="flex items-center gap-3">
                    <div class="bg-blue-100 p-2 rounded-lg"><i class="fa-solid fa-industry text-blue-600 text-xl"></i></div>
                    <div>
                        <h1 class="text-xl font-bold text-slate-800 leading-none">Molino Pro</h1>
                        <span class="text-[10px] text-gray-500" id="userEmailDisplay">...</span>
                    </div>
                </div>
                <button onclick="logout()" class="text-red-500 p-2 rounded-full"><i class="fa-solid fa-right-from-bracket"></i></button>
            </div>
            <nav class="flex overflow-x-auto bg-white border-t border-slate-100 no-scrollbar">
                <button onclick="switchTab('dashboard')" class="tab-btn active flex-1 py-3 px-4 text-sm font-bold text-blue-600 border-b-2 border-blue-600" id="tab-dashboard">
                    <i class="fa-solid fa-gauge mx-1"></i> Surveillance
                </button>
                <button onclick="switchTab('analysis')" class="tab-btn flex-1 py-3 px-4 text-sm font-bold text-gray-500 hover:text-blue-500" id="tab-analysis">
                    <i class="fa-solid fa-chart-pie mx-1"></i> Rapports
                </button>
                <button onclick="switchTab('history')" class="tab-btn flex-1 py-3 px-4 text-sm font-bold text-gray-500 hover:text-blue-500" id="tab-history">
                    <i class="fa-solid fa-box-archive mx-1"></i> Archive
                </button>
                <button onclick="switchTab('settings')" class="tab-btn flex-1 py-3 px-4 text-sm font-bold text-gray-500 hover:text-blue-500" id="tab-settings">
                    <i class="fa-solid fa-gear mx-1"></i> Réglages
                </button>
            </nav>
        </header>

        <main class="max-w-7xl mx-auto p-4 pb-20">

            <div id="view-dashboard" class="tab-content active space-y-6">
                <div class="bg-white rounded-2xl p-6 border">
                    <h2 class="text-lg font-bold mb-4">Enregistrer une lecture</h2>
                    <form id="entryForm" class="grid grid-cols-1 md:grid-cols-4 gap-4 items-end">
                        <div>
                            <label class="block text-xs font-bold text-gray-500 mb-1">Silo</label>
                            <select id="silounSelect" class="w-full p-2.5 border rounded-lg bg-slate-50"></select>
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-gray-500 mb-1">Poids (T)</label>
                            <input type="number" id="weightInput" step="0.01" class="w-full p-2.5 border rounded-lg bg-slate-50 text-left" placeholder="0.00">
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-gray-500 mb-1">Date et heure</label>
                            <input type="datetime-local" id="dateTimeInput" class="w-full p-2.5 border rounded-lg bg-slate-50 text-sm">
                        </div>
                        <button type="submit" class="bg-blue-600 text-white font-bold py-2.5 px-4 rounded-lg">Enregistrer <i class="fa-solid fa-check mx-1"></i></button>
                    </form>
                </div>

                <div id="gauges-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4"></div>

                <div class="bg-white rounded-2xl border overflow-hidden">
                    <div class="p-4 border-b bg-slate-50 flex justify-between items-center">
                        <h3 class="font-bold text-slate-700">Journal de la session</h3>
                        <span id="session-counter" class="text-xs bg-blue-100 text-blue-800 px-2 py-1 rounded-full font-bold">0</span>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm text-right">
                            <thead class="bg-slate-100 text-slate-600">
                                <tr>
                                    <th class="p-3 text-center">Heure</th>
                                    <th class="p-3 text-center">Silo</th>
                                    <th class="p-3 text-center">Poids</th>
                                    <th class="p-3 text-center">Différence</th>
                                    <th class="p-3"></th>
                                </tr>
                            </thead>
                            <tbody id="recordsBody" class="divide-y divide-slate-100"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="view-analysis" class="tab-content space-y-6">
                <div class="bg-gradient-to-br from-slate-800 to-slate-900 text-white rounded-2xl p-6">
                    <h3 class="text-lg font-bold mb-4">Rapport Instantané</h3>
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                        <div class="bg-white/10 p-4 rounded-xl">
                            <span class="text-slate-300 text-xs block mb-1">Statut Général</span>
                            <span class="text-xl font-bold" id="report-status">En attente...</span>
                        </div>
                        <div class="bg-white/10 p-4 rounded-xl">
                            <span class="text-slate-300 text-xs block mb-1">Mouvement Total (T)</span>
                            <span class="text-xl font-bold text-yellow-400" id="report-total-moved">0,00</span>
                        </div>
                        <div class="bg-white/10 p-4 rounded-xl">
                            <span class="text-slate-300 text-xs block mb-1">Vitesse Max</span>
                            <span class="text-xl font-bold text-green-400" id="report-max-speed">0,00 T/h</span>
                        </div>
                        <div class="bg-white/10 p-4 rounded-xl">
                            <span class="text-slate-300 text-xs block mb-1">Vitesse Moyenne (session)</span>
                            <span class="text-xl font-bold text-indigo-300" id="report-avg-speed">-</span>
                        </div>
                    </div>
                </div>

                <div id="prediction-cards" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>

                <div class="bg-white rounded-2xl border overflow-hidden">
                    <div class="p-4 border-b bg-slate-50">
                        <h3 class="font-bold">Détails des Vitesses</h3>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm text-right">
                            <thead class="bg-slate-100 text-slate-600">
                                <tr>
                                    <th class="p-3 text-center">Silo</th>
                                    <th class="p-3 text-center">Activité</th>
                                    <th class="p-3 text-center">T/h</th>
                                    <th class="p-3 text-center">T / 30min</th>
                                    <th class="p-3 text-center">T / min</th>
                                    <th class="p-3 text-center">Kg / s</th>
                                </tr>
                            </thead>
                            <tbody id="analysisBody" class="divide-y divide-slate-100 font-mono"></tbody>
                        </table>
                    </div>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="bg-white p-4 rounded-2xl border h-64"><canvas id="chartWeights"></canvas></div>
                    <div class="bg-white p-4 rounded-2xl border h-64"><canvas id="chartDiff"></canvas></div>
                </div>
            </div>

            <div id="view-history" class="tab-content">
                <div class="bg-white rounded-2xl border overflow-hidden">
                    <div class="p-4 border-b bg-slate-50 flex justify-between items-center">
                        <h3 class="font-bold text-slate-700">Archive et Historique</h3>
                        <button onclick="loadUserHistory()" class="text-blue-600 px-3 py-1 rounded">Actualiser</button>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm text-right">
                            <thead class="bg-slate-100 text-slate-600">
                                <tr>
                                    <th class="p-4 text-center">التاريخ</th>
                                    <th class="p-4 text-center">Total Mouvement</th>
                                    <th class="p-4 text-center">Nb. Lectures</th>
                                    <th class="p-4 text-center">Vitesse Moyenne (T/h)</th>
                                    <th class="p-4 text-center">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="historyBody" class="divide-y divide-slate-100"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="view-settings" class="tab-content">
                <div class="bg-white rounded-2xl p-6 border mb-6">
                    <h3 class="font-bold text-lg mb-4">Langue de l'interface</h3>
                    <div class="flex items-center gap-4">
                        <select id="languageSelect" class="w-full max-w-xs p-3 border rounded-lg bg-slate-50">
                            <option value="fr">Français</option>
                            <option value="en">English</option>
                            <option value="ar">العربية</option>
                        </select>
                        <button onclick="saveLanguageSetting()" class="bg-blue-600 text-white py-3 px-6 rounded-lg">Sauvegarder</button>
                    </div>
                </div>

                <div class="bg-white rounded-2xl p-6 border">
                    <h3 class="font-bold text-lg mb-4">Réglages des Capacités des Silos</h3>
                    <div id="siloSettingsContainer" class="space-y-3"></div>
                </div>
            </div>

        </main>
    </div>

    <div id="historyModal" class="fixed inset-0 bg-black/60 z-50 hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl w-full max-w-3xl max-h-[85vh] overflow-y-auto relative">
            <div class="p-6 border-b sticky top-0 bg-white z-10 flex justify-between items-center">
                <h3 class="text-xl font-bold text-slate-800">Détails du Rapport</h3>
                <button onclick="document.getElementById('historyModal').classList.add('hidden')" class="text-gray-400 hover:text-red-500 text-2xl"><i class="fa-solid fa-xmark"></i></button>
            </div>
            <div class="p-6 space-y-6">
                <div class="grid grid-cols-2 gap-4 text-sm">
                    <div class="bg-slate-50 p-3 rounded border"><span>Date</span>: <span id="modal-date" class="font-bold"></span></div>
                    <div class="bg-slate-50 p-3 rounded border"><span>Total</span>: <span id="modal-total" class="font-bold text-blue-600"></span></div>
                </div>
                <div>
                    <h4 class="font-bold mb-2 text-sm text-gray-500">Détails:</h4>
                    <div class="overflow-x-auto border rounded-lg">
                        <table class="w-full text-sm text-right">
                            <thead class="bg-gray-50 text-gray-600">
                                <tr>
                                    <th class="p-2 text-center">Heure</th>
                                    <th class="p-2 text-center">Silo</th>
                                    <th class="p-2 text-center">Poids</th>
                                    <th class="p-2 text-center">Différence</th>
                                </tr>
                            </thead>
                            <tbody id="modal-records-body" class="divide-y divide-gray-100"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // === Configuration Firebase (laissez comme dans votre projet) ===
        const firebaseConfig = {
            apiKey: "AIzaSyCXeIS89Cd0DKz7BTsIfQDr3Ckb544dR8k",
            authDomain: "siloun.firebaseapp.com",
            databaseURL: "https://siloun-default-rtdb.firebaseio.com",
            projectId: "siloun",
            storageBucket: "siloun.firebasestorage.app",
            messagingSenderId: "111587591132",
            appId: "1:111587591132:web:0b7e481138e8885076c519"
        };
        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.database();

        const ADMIN_EMAIL = 'koreanarabione@gmail.com';
        let currentUser = null;
        let appSettings = { SILOS: [] };
        let currentSession = [];
        let charts = {};
        let isLoginMode = true;

        // --- Parameters to help with inaccurate data ---
        const MIN_TIME_SEC = 10; // ignore speed calculations if time difference < 10s (probable noisy input)
        const MAX_ACCEPTABLE_TPH = 500; // clamp/ignore spikes above this threshold as likely erroneous

        // --- Locale helpers ---
        const formatNumber = (num, decimals = 2) => {
            if (num === null || num === undefined || isNaN(num)) return '-';
            return new Intl.NumberFormat('fr-FR', { minimumFractionDigits: decimals, maximumFractionDigits: decimals }).format(num);
        };

        const formatDate = (isoDate, options) => {
            return new Date(isoDate).toLocaleDateString('en-US', options);
        };

        // --- Auth state ---
        auth.onAuthStateChanged(user => {
            if (user) {
                currentUser = user;
                document.getElementById('auth-view').classList.add('hidden');
                document.getElementById('app-view').classList.remove('hidden');
                document.getElementById('userEmailDisplay').textContent = user.email;
                initializeApp();
            } else {
                currentUser = null;
                document.getElementById('auth-view').classList.remove('hidden');
                document.getElementById('app-view').classList.add('hidden');
            }
        });

        function toggleAuthMode() { isLoginMode = !isLoginMode; }

        document.getElementById('authForm').addEventListener('submit', e => {
            e.preventDefault();
            const email = document.getElementById('emailInput').value;
            const pass = document.getElementById('passwordInput').value;
            const p = isLoginMode ? auth.signInWithEmailAndPassword(email, pass) : auth.createUserWithEmailAndPassword(email, pass);
            p.catch(err => alert(err.message));
        });

        function logout() { auth.signOut(); }

        async function initializeApp() {
            await loadSettings();
            await loadSession();
            updateUI();
            updateDateTime();
            setInterval(updateDateTime, 60000);
        }

        function loadSettings() {
            return db.ref('molino_app_data/settings').once('value').then(snap => {
                const def = [
                    { id: 1, name: 'Siloun 1', rated: 63, max: 75 },
                    { id: 2, name: 'Siloun 2', rated: 63, max: 75 },
                    { id: 3, name: 'Siloun 3', rated: 63, max: 75 },
                    { id: 4, name: 'Siloun 4', rated: 63, max: 75 }
                ];
                appSettings.SILOS = (snap.val() && snap.val().SILOS) ? snap.val().SILOS : def;
                renderSiloSettingsInputs();
                renderGauges();
                updateSiloSelect();
            });
        }

        function loadSession() {
            if (!currentUser) return Promise.resolve();
            return db.ref(`molino_app_data/sessions/${currentUser.uid}`).once('value').then(snap => {
                const data = snap.val();
                currentSession = data ? Object.values(data).sort((a,b) => a.ts - b.ts) : [];
            });
        }

        function updateUI() {
            appSettings.SILOS.forEach(silo => {
                const recs = currentSession.filter(r => r.silo === silo.name).sort((a,b) => a.ts - b.ts);
                const lastWeight = recs.length ? parseFloat(recs[recs.length-1].weight) : 0;
                updateGauge(silo.id, lastWeight, silo.rated, silo.max);
            });
            document.getElementById('session-counter').textContent = currentSession.length || 0;
            renderRecords();
            performLocalAnalysis();
        }

        function renderGauges() {
            document.getElementById('gauges-container').innerHTML = appSettings.SILOS.map(s => `
                <div class="bg-white p-4 rounded-xl shadow-sm border relative overflow-hidden">
                    <div class="flex justify-between mb-2">
                        <span class="font-bold text-sm">${s.name}</span>
                        <span class="font-mono font-bold text-blue-600" id="val-${s.id}">${formatNumber(0)} T</span>
                    </div>
                    <div class="h-3 bg-slate-100 rounded-full overflow-hidden flex relative">
                        <div id="bar-norm-${s.id}" class="h-full bg-blue-500 gauge-bar" style="width: 0%"></div>
                        <div id="bar-ext-${s.id}" class="h-full bg-red-500 gauge-bar" style="width: 0%"></div>
                    </div>
                    <div id="alert-${s.id}" class="hidden mt-2 text-[10px] text-red-600 font-bold bg-red-50 px-2 py-1 rounded text-center animate-pulse">
                        <i class="fa-solid fa-triangle-exclamation"></i> Full Imminent
                    </div>
                </div>
            `).join('');
        }

        function updateGauge(id, val, rated, max) {
            document.getElementById(`val-${id}`).textContent = formatNumber(val) + ' T';
            const normBar = document.getElementById(`bar-norm-${id}`);
            const extBar = document.getElementById(`bar-ext-${id}`);
            const alertBox = document.getElementById(`alert-${id}`);

            const normPercentage = Math.min(val, rated) / rated * 100;
            normBar.style.width = `${normPercentage}%`;
            if (normPercentage > 85) normBar.classList.replace('bg-blue-500', 'bg-yellow-500'); else normBar.classList.replace('bg-yellow-500', 'bg-blue-500');

            if (val > rated) {
                const extValue = val - rated;
                const extCapacity = max - rated;
                const extPercentage = Math.min(extValue, extCapacity) / extCapacity * 100;
                extBar.style.width = `${extPercentage}%`;
            } else {
                extBar.style.width = '0%';
            }

            if (val >= max * 0.9) alertBox.classList.remove('hidden'); else alertBox.classList.add('hidden');
        }

        document.getElementById('entryForm').addEventListener('submit', async e => {
            e.preventDefault();
            const siloName = document.getElementById('silounSelect').value;
            const weightInput = document.getElementById('weightInput');
            const weight = parseFloat(weightInput.value);
            const dateVal = document.getElementById('dateTimeInput').value;
            const selectedSilo = appSettings.SILOS.find(s => s.name === siloName);
            if(!siloName || isNaN(weight) || !dateVal || !selectedSilo) return alert('Champs incomplets');

            if (weight > selectedSilo.max) {
                alert(`Erreur capacité: ${formatNumber(weight)} T > ${formatNumber(selectedSilo.max)} T`);
                weightInput.focus();
                return;
            }
            const newTimestamp = new Date(dateVal).getTime();
            const prevRecs = currentSession.filter(r => r.silo === siloName).sort((a,b) => a.ts - b.ts);
            if (prevRecs.length > 0) {
                const lastTimestamp = prevRecs[prevRecs.length - 1].ts;
                if (newTimestamp < lastTimestamp) return alert('Erreur: la date doit être >= dernière lecture pour ce silo.');
            }

            const prevW = prevRecs.length ? parseFloat(prevRecs[prevRecs.length-1].weight) : 0;
            const diffVal = prevRecs.length ? (weight - prevW) : 0;
            const diff = diffVal.toFixed(2);

            const record = {
                id: Date.now(),
                ts: newTimestamp,
                dateStr: dateVal,
                silo: siloName,
                weight: weight,
                diff: diff
            };

            currentSession.push(record);
            await db.ref(`molino_app_data/sessions/${currentUser.uid}/${record.id}`).set(record);
            updateUI();
            document.getElementById('weightInput').value = '';
        });

        function renderRecords() {
            const tbody = document.getElementById('recordsBody');
            tbody.innerHTML = [...currentSession].sort((a,b) => b.ts - a.ts).map(r => `
                <tr class="hover:bg-slate-50 transition">
                    <td class="p-3 text-center text-gray-500">${formatDate(r.ts, { hour: '2-digit', minute: '2-digit' })}</td>
                    <td class="p-3 text-center font-bold text-slate-700">${r.silo}</td>
                    <td class="p-3 text-center" dir="ltr">${formatNumber(r.weight)}</td>
                    <td class="p-3 text-center font-bold ${parseFloat(r.diff) > 0 ? 'text-green-600' : parseFloat(r.diff) < 0 ? 'text-red-500' : 'text-gray-400'}" dir="ltr">${parseFloat(r.diff) > 0 ? '+' : ''}${formatNumber(r.diff)}</td>
                    <td class="p-3"><button onclick="deleteRec(${r.id})" class="text-red-300 hover:text-red-500"><i class="fa-solid fa-trash"></i></button></td>
                </tr>
            `).join('');
        }

        async function deleteRec(id) {
            if(!confirm('Supprimer?')) return;
            await db.ref(`molino_app_data/sessions/${currentUser.uid}/${id}`).remove();
            currentSession = currentSession.filter(r => r.id !== id);
            updateUI();
        }

        function performLocalAnalysis() {
            const labels = currentSession.map(r => formatDate(r.ts, { hour: '2-digit', minute: '2-digit' }));
            const weights = currentSession.map(r => r.weight);
            const diffs = currentSession.map(r => parseFloat(r.diff));

            let totalMoved = 0;
            let maxSpeed = 0;
            let activeSilosCount = 0;
            
            let cardsHtml = '';
            let tableHtml = '';

            // For overall session average (archive value)
            let firstTs = null;
            let lastTs = null;
            currentSession.forEach(r => { if(!firstTs || r.ts < firstTs) firstTs = r.ts; if(!lastTs || r.ts > lastTs) lastTs = r.ts; });

            appSettings.SILOS.forEach(silo => {
                const siloRecs = currentSession.filter(r => r.silo === silo.name).sort((a,b) => a.ts - b.ts);
                
                if (siloRecs.length >= 2) {
                    const last = siloRecs[siloRecs.length - 1];
                    const prev = siloRecs[siloRecs.length - 2];
                    
                    const weightDiff = parseFloat(last.weight) - parseFloat(prev.weight);
                    const timeDiffSec = (last.ts - prev.ts) / 1000; // seconds
                    const timeDiffHours = timeDiffSec / 3600;
                    
                    let speedTph = null;
                    let reliable = true;
                    if (timeDiffSec < MIN_TIME_SEC) {
                        reliable = false; // data too close in time -> ignore for speed calc
                    } else {
                        speedTph = weightDiff / timeDiffHours; // T/h
                        if (!isFinite(speedTph) || Math.abs(speedTph) > MAX_ACCEPTABLE_TPH) {
                            reliable = false; // spike or invalid
                        }
                    }

                    if (speedTph !== null && reliable && Math.abs(speedTph) > 0.01) {
                        activeSilosCount++;
                        if(Math.abs(speedTph) > maxSpeed) maxSpeed = Math.abs(speedTph);
                        totalMoved += Math.abs(weightDiff);
                    }

                    // convert speeds into other units (with checks)
                    const tphDisplay = reliable && speedTph !== null ? formatNumber(speedTph,1) : '—';
                    const t30Display = reliable && speedTph !== null ? formatNumber(speedTph/2,2) : '—'; // T per 30 min = tph/2
                    const tminDisplay = reliable && speedTph !== null ? formatNumber(speedTph/60,3) : '—';
                    const kgsecDisplay = reliable && speedTph !== null ? formatNumber((speedTph*1000)/3600,3) : '—';
                    
                    const status = (reliable && speedTph !== null && speedTph > 0) ? `<span class="text-green-600 font-bold">Filling</span>` : (reliable && speedTph !== null && speedTph < 0 ? `<span class="text-red-600 font-bold">Emptying</span>` : `<span class="text-gray-400">Inconnu</span>`);
                    const unreliableNote = reliable ? '' : '<div class="text-xs text-orange-500 mt-2">Données peu fiables (intervalle court/spike)</div>';

                    tableHtml += `
                        <tr class="hover:bg-slate-50 transition ${reliable? '':'unreliable'}">
                            <td class="p-3 font-bold text-center">${silo.name}</td>
                            <td class="p-3 text-center">${status}${unreliableNote}</td>
                            <td class="p-3 font-mono text-center" dir="ltr">${tphDisplay}</td>
                            <td class="p-3 font-mono text-center" dir="ltr">${t30Display}</td>
                            <td class="p-3 font-mono text-center" dir="ltr">${tminDisplay}</td>
                            <td class="p-3 font-mono text-center" dir="ltr">${kgsecDisplay}</td>
                        </tr>`;

                    // Card for silo with detailed display
                    cardsHtml += `
                        <div class="bg-white p-4 rounded-xl shadow-sm ${reliable ? 'border-l-4 border-green-200' : 'border-l-4 border-orange-100'}">
                            <div class="flex justify-between items-start">
                                <h4 class="font-bold text-lg">${silo.name}</h4>
                                <span class="text-xs bg-white px-2 py-1 rounded border" dir="ltr">${tphDisplay} T/h</span>
                            </div>
                            <div class="mt-3 text-sm text-slate-700">${reliable ? `~ ${t30Display} T / 30min · ${tminDisplay} T/min · ${kgsecDisplay} Kg/s` : 'Données peu fiables pour vitesse'}</div>
                        </div>`;
                }
            });

            // compute session average (for display + archive storing)
            let sessionAvgTph = '-';
            let sessionDurationHours = 0;
            if (firstTs && lastTs && lastTs > firstTs) {
                sessionDurationHours = (lastTs - firstTs) / 3600000;
                // total positive moved (sum of positive diffs) computed earlier as totalMoved
                if (sessionDurationHours > 0) {
                    const avg = totalMoved / sessionDurationHours;
                    sessionAvgTph = formatNumber(avg,2);
                } else {
                    sessionAvgTph = '—';
                }
            } else {
                sessionAvgTph = '—';
            }

            document.getElementById('report-total-moved').textContent = formatNumber(totalMoved);
            document.getElementById('report-max-speed').textContent = maxSpeed > 0 ? formatNumber(maxSpeed,1) + ' T/h' : '-';
            document.getElementById('report-status').textContent = activeSilosCount > 0 ? `Active (${activeSilosCount})` : 'Inactive';
            document.getElementById('report-avg-speed').textContent = sessionAvgTph !== '-' ? (sessionAvgTph + ' T/h') : '-';
            
            document.getElementById('prediction-cards').innerHTML = cardsHtml || `<div class="col-span-2 text-center text-gray-400 py-8">No Activity</div>`;
            document.getElementById('analysisBody').innerHTML = tableHtml || `<tr><td colspan="6" class="text-center p-6 text-gray-400">Start recording</td></tr>`;

            updateCharts(labels, weights, diffs);
        }

        function updateCharts(labels, weights, diffs) {
            if (charts.w) charts.w.destroy();
            if (charts.d) charts.d.destroy();
            const ctxW = document.getElementById('chartWeights').getContext('2d');
            charts.w = new Chart(ctxW, {
                type: 'line',
                data: { labels: labels, datasets: [{ label: 'Weight', data: weights, borderColor: '#3b82f6', tension: 0.4, pointRadius: 2 }] },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } }
            });
            const ctxD = document.getElementById('chartDiff').getContext('2d');
            charts.d = new Chart(ctxD, {
                type: 'bar',
                data: { labels: labels, datasets: [{ label: 'Change', data: diffs, backgroundColor: diffs.map(d => d>0?'#22c55e':'#ef4444') }] },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } }
            });
        }

        async function endWork() {
            if(!currentSession.length) return alert('No data');
            if(!confirm('Terminer la session et archiver?')) return;

            // compute archive summary
            const sorted = [...currentSession].sort((a,b) => a.ts - b.ts);
            const first = sorted[0];
            const last = sorted[sorted.length-1];
            const durationHours = (last.ts - first.ts) / 3600000;
            const totalPos = currentSession.reduce((acc, r) => acc + (parseFloat(r.diff) > 0 ? parseFloat(r.diff) : 0), 0);
            const avgTph = (durationHours > 0) ? (totalPos / durationHours) : null;
            const report = {
                date: new Date().toISOString(),
                totalMoved: totalPos.toFixed(2),
                recordsCount: currentSession.length,
                totalDurationHours: durationHours,
                avgTph: avgTph !== null ? parseFloat(avgTph.toFixed(2)) : null,
                data: currentSession
            };

            await db.ref(`molino_app_data/history/${currentUser.uid}/${Date.now()}`).set(report);
            await db.ref(`molino_app_data/sessions/${currentUser.uid}`).remove();
            
            currentSession = [];
            updateUI();
            switchTab('history');
            loadUserHistory();
        }

        function loadUserHistory() {
            const tbody = document.getElementById('historyBody');
            tbody.innerHTML = '<tr><td colspan="5" class="text-center p-6"><span class="loader"></span></td></tr>';
            db.ref(`molino_app_data/history/${currentUser.uid}`).limitToLast(50).once('value').then(snap => {
                tbody.innerHTML = '';
                if(!snap.val()) { 
                    tbody.innerHTML = `<tr><td colspan="5" class="text-center p-6 text-gray-500">No history</td></tr>`; 
                    return; 
                }
                Object.entries(snap.val()).reverse().forEach(([key, val]) => {
                    let displayTotal = val.totalMoved !== undefined ? val.totalMoved : (val.total !== undefined ? val.total : '0.00');
                    let displayCount = val.recordsCount !== undefined ? val.recordsCount : (val.data && Array.isArray(val.data) ? val.data.length : 0);
                    const avgDisplay = val.avgTph !== undefined && val.avgTph !== null ? formatNumber(val.avgTph,2) + ' T/h' : '— (durée courte)';
                    const dateOptions = { weekday:'short', year:'numeric', month:'short', day:'numeric', hour: '2-digit', minute: '2-digit' };
                    tbody.innerHTML += `
                        <tr class="hover:bg-slate-50 transition border-b border-slate-100">
                            <td class="p-4 text-center">${formatDate(val.date, dateOptions)}</td>
                            <td class="p-4 text-center font-bold text-blue-600" dir="ltr">${formatNumber(displayTotal)} T</td>
                            <td class="p-4 text-center text-sm text-gray-500" dir="ltr">${displayCount}</td>
                            <td class="p-4 text-center font-mono" dir="ltr">${avgDisplay}</td>
                            <td class="p-4 text-center"><button onclick='viewHistoryDetails(${JSON.stringify(val)})' class="bg-blue-50 text-blue-600 px-3 py-1.5 rounded text-xs font-bold">Voir</button></td>
                        </tr>
                    `;
                });
            });
        }

        function viewHistoryDetails(data) {
            document.getElementById('modal-date').textContent = formatDate(data.date, { year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit' });
            const displayTotal = data.totalMoved !== undefined ? data.totalMoved : (data.total !== undefined ? data.total : '0.00');
            document.getElementById('modal-total').textContent = formatNumber(displayTotal) + ' T';
            const tbody = document.getElementById('modal-records-body');
            tbody.innerHTML = '';
            const records = data.data || data.records || [];
            if(records.length > 0) {
                records.forEach(r => {
                    tbody.innerHTML += `
                        <tr>
                            <td class="p-2 text-center text-gray-500 text-xs">${formatDate(r.ts, { hour: '2-digit', minute: '2-digit' })}</td>
                            <td class="p-2 text-center font-bold text-xs">${r.silo}</td>
                            <td class="p-2 text-center text-xs" dir="ltr">${formatNumber(r.weight)}</td>
                            <td class="p-2 text-center text-xs font-mono" dir="ltr">${formatNumber(r.diff)}</td>
                        </tr>
                    `;
                });
            } else {
                 tbody.innerHTML = `<tr><td colspan="4" class="text-center p-4">No details</td></tr>`;
            }
            document.getElementById('historyModal').classList.remove('hidden');
        }

        function updateSiloSelect() {
            document.getElementById('silounSelect').innerHTML = appSettings.SILOS.map(s => `<option value="${s.name}">${s.name}</option>`).join('');
        }

        function renderSiloSettingsInputs() {
            const container = document.getElementById('siloSettingsContainer');
            container.innerHTML = appSettings.SILOS.map(s => `
                <div class="flex items-center gap-2 bg-slate-50 p-3 rounded-lg border">
                    <div class="w-1/3 text-sm font-bold text-slate-700">${s.name}</div>
                    <div class="w-1/3">
                        <label class="text-[10px] text-gray-400 block">Rated (T)</label>
                        <input type="number" min="0" max="${s.max}" value="${s.rated}" data-id="${s.id}" data-key="rated" class="w-full p-1 border rounded text-sm">
                    </div>
                    <div class="w-1/3">
                        <label class="text-[10px] text-gray-400 block">Max (T)</label>
                        <input type="number" min="${s.rated}" value="${s.max}" data-id="${s.id}" data-key="max" class="w-full p-1 border rounded text-sm">
                    </div>
                </div>
            `).join('');
        }

        document.getElementById('settingsForm')?.addEventListener('submit', async e => {
            e.preventDefault();
            if(!currentUser || currentUser.email !== ADMIN_EMAIL) return alert('No permission');
            const newSilos = appSettings.SILOS.map(s => {
                const rated = document.querySelector(`input[data-key="rated"][data-id="${s.id}"]`).value;
                const max = document.querySelector(`input[data-key="max"][data-id="${s.id}"]`).value;
                return { ...s, rated: parseFloat(rated), max: parseFloat(max) };
            });
            await db.ref('molino_app_data/settings').update({ SILOS: newSilos });
            alert('Saved');
            location.reload();
        });

        function updateDateTime() {
            const now = new Date();
            now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
            document.getElementById('dateTimeInput').value = now.toISOString().slice(0, 16);
        }

        function switchTab(tabId) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(el => {
                el.classList.remove('text-blue-600', 'border-b-2', 'border-blue-600');
                el.classList.add('text-gray-500');
            });
            document.getElementById(`view-${tabId}`).classList.add('active');
            const btn = document.getElementById(`tab-${tabId}`);
            if (btn) { btn.classList.remove('text-gray-500'); btn.classList.add('text-blue-600', 'border-b-2', 'border-blue-600'); }
            if(tabId === 'history') loadUserHistory();
            if(tabId === 'analysis') performLocalAnalysis();
        }

        // Service Worker registration (optional)
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                try {
                    navigator.serviceWorker.register('/service-worker.js')
                        .then(registration => console.log('SW registered', registration.scope))
                        .catch(err => console.log('SW failed', err));
                } catch(e) { console.warn('SW error', e); }
            });
        }
    </script>
</body>
</html>
