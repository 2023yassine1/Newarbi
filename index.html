<!DOCTYPE html>
<html lang="fr" dir="ltr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title data-i18n="app_title">Molino Pro - V9.4 (Profile)</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.min.js"></script>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

    <style>
        body { font-family: 'Cairo', sans-serif; background-color: #f1f5f9; } 
        .tab-content { display: none; animation: fadeIn 0.4s ease-out; }
        .tab-content.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        .loader { border: 3px solid #e2e8f0; border-top: 3px solid #3b82f6; border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite; display: inline-block; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        .gauge-bar { transition: width 1s cubic-bezier(0.4, 0, 0.2, 1); }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; /* IE and Edge */ scrollbar-width: none; /* Firefox */ }
    </style>
</head>
<body class="bg-slate-100 text-slate-800 min-h-screen">

    <div id="auth-view" class="fixed inset-0 bg-slate-900 z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl p-8 w-full max-w-md text-center">
            <h1 class="text-3xl font-bold text-blue-600 mb-2">Molino <span class="text-slate-700">Pro</span></h1>
            <p class="text-gray-500 mb-6" data-i18n="app_subtitle">Système de gestion intelligent</p>
            
            <form id="authForm" class="space-y-4">
                <input type="email" id="emailInput" data-i18n-placeholder="email_placeholder" placeholder="Email" required class="w-full p-3 border rounded-lg outline-none focus:ring-2 focus:ring-blue-500" dir="ltr">
                <input type="password" id="passwordInput" data-i18n-placeholder="password_placeholder" placeholder="Mot de passe" required class="w-full p-3 border rounded-lg outline-none focus:ring-2 focus:ring-blue-500" dir="ltr">
                
                <div id="authMessage" class="hidden p-3 rounded text-sm font-bold bg-red-100 text-red-600 border border-red-200"></div>
                
                <button type="submit" id="authBtn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-lg transition shadow-lg" data-i18n="btn_enter">Entrer</button>
            </form>
            <p class="mt-4 text-sm text-gray-500 cursor-pointer hover:text-blue-600 underline" onclick="toggleAuthMode()" id="authToggleText" data-i18n="toggle_auth_login">Basculer (Connexion / Inscription)</p>
        </div>
    </div>

    <div id="app-view" class="hidden">
        
        <header class="bg-white shadow-sm sticky top-0 z-40">
            <div class="max-w-7xl mx-auto px-4 py-3 flex justify-between items-center">
                <div class="flex items-center gap-3">
                    <div class="bg-blue-100 p-2 rounded-lg"><i class="fa-solid fa-industry text-blue-600 text-xl"></i></div>
                    <div>
                        <h1 class="text-xl font-bold text-slate-800 leading-none">Molino Pro</h1>
                        <span class="text-[10px] text-gray-500" id="userEmailDisplay">...</span>
                    </div>
                </div>
                <button onclick="logout()" class="text-red-500 hover:bg-red-50 p-2 rounded-full transition"><i class="fa-solid fa-right-from-bracket"></i></button>
            </div>
            
            <nav class="flex overflow-x-auto bg-white border-t border-slate-100 no-scrollbar">
                <button onclick="switchTab('dashboard')" class="tab-btn active flex-1 py-3 px-4 text-sm font-bold text-blue-600 border-b-2 border-blue-600 transition" id="tab-dashboard">
                    <i class="fa-solid fa-gauge mx-1"></i> <span data-i18n="nav_dashboard">Surveillance</span>
                </button>
                <button onclick="switchTab('analysis')" class="tab-btn flex-1 py-3 px-4 text-sm font-bold text-gray-500 hover:text-blue-500 transition" id="tab-analysis">
                    <i class="fa-solid fa-chart-pie mx-1"></i> <span data-i18n="nav_reports">Rapports</span>
                </button>
                <button onclick="switchTab('history')" class="tab-btn flex-1 py-3 px-4 text-sm font-bold text-gray-500 hover:text-blue-500 transition" id="tab-history">
                    <i class="fa-solid fa-box-archive mx-1"></i> <span data-i18n="nav_archive">Archive</span>
                </button>
                <button onclick="switchTab('settings')" class="tab-btn flex-1 py-3 px-4 text-sm font-bold text-gray-500 hover:text-blue-500 transition" id="tab-settings">
                    <i class="fa-solid fa-gear mx-1"></i> <span data-i18n="nav_settings">Réglages</span>
                </button>
            </nav>
        </header>

        <main class="max-w-7xl mx-auto p-4 pb-20">

            <div id="view-dashboard" class="tab-content active space-y-6">
                <div class="bg-white rounded-2xl shadow-sm p-6 border border-slate-200">
                    <h2 class="text-lg font-bold mb-4 flex items-center gap-2 text-slate-700">
                        <i class="fa-solid fa-pen text-blue-500"></i> <span data-i18n="title_new_entry">Enregistrer une lecture</span>
                    </h2>
                    <form id="entryForm" class="grid grid-cols-1 md:grid-cols-5 gap-4 items-end">
                        <div>
                            <label class="block text-xs font-bold text-gray-500 mb-1" data-i18n="label_silo">Silo</label>
                            <select id="silounSelect" class="w-full p-2.5 border rounded-lg bg-slate-50 outline-none focus:border-blue-500"></select>
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-gray-500 mb-1" data-i18n="label_weight">Poids Actuel (T)</label>
                            <input type="number" id="weightInput" step="0.01" class="w-full p-2.5 border rounded-lg bg-slate-50 outline-none focus:border-blue-500 text-left" placeholder="0.00" dir="ltr">
                        </div>
                        <div class="relative">
                            <label class="block text-xs font-bold text-orange-500 mb-1"><i class="fa-solid fa-truck-ramp-box"></i> <span data-i18n="label_truck">Sortie Camion (T)</span></label>
                            <input type="number" id="truckInput" step="0.01" class="w-full p-2.5 border rounded-lg bg-orange-50 outline-none focus:border-orange-500 text-left" placeholder="0.00" dir="ltr">
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-gray-500 mb-1" data-i18n="label_date">Date et heure</label>
                            <input type="datetime-local" id="dateTimeInput" class="w-full p-2.5 border rounded-lg bg-slate-50 outline-none focus:border-blue-500 text-sm" dir="ltr">
                        </div>
                        <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2.5 px-4 rounded-lg transition shadow-md shadow-blue-200">
                            <span data-i18n="btn_record">Enregistrer</span> <i class="fa-solid fa-check mx-1"></i>
                        </button>
                    </form>
                </div>

                <div id="gauges-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4"></div>

                <div class="bg-white rounded-2xl shadow-sm overflow-hidden border border-slate-200">
                    <div class="p-4 border-b bg-slate-50 flex justify-between items-center">
                        <h3 class="font-bold text-slate-700" data-i18n="title_session_log">Journal de la session</h3>
                        <span id="session-counter" class="text-xs bg-blue-100 text-blue-800 px-2 py-1 rounded-full font-bold">0</span>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm text-right">
                            <thead class="bg-slate-100 text-slate-600">
                                <tr>
                                    <th class="p-3 text-center" data-i18n="th_time">Heure</th>
                                    <th class="p-3 text-center" data-i18n="th_silo">Silo</th>
                                    <th class="p-3 text-center" data-i18n="th_weight">Poids</th>
                                    <th class="p-3 text-center" data-i18n="th_truck">Camion</th>
                                    <th class="p-3 text-center" data-i18n="th_diff">Diff (Prod)</th>
                                    <th class="p-3"></th>
                                </tr>
                            </thead>
                            <tbody id="recordsBody" class="divide-y divide-slate-100"></tbody>
                        </table>
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <button onclick="endWork()" class="bg-red-500 hover:bg-red-600 text-white py-3 rounded-xl font-bold shadow-lg shadow-red-200 transition">
                        <span data-i18n="btn_finish">Terminer</span> <i class="fa-solid fa-save mx-1"></i>
                    </button>
                    <button onclick="switchTab('analysis')" class="bg-slate-700 hover:bg-slate-800 text-white py-3 rounded-xl font-bold shadow-lg transition">
                        <span data-i18n="btn_analyze">Analyse</span> <i class="fa-solid fa-chart-line mx-1"></i>
                    </button>
                </div>
            </div>

            <div id="view-analysis" class="tab-content space-y-6">
                <div class="bg-gradient-to-br from-slate-800 to-slate-900 text-white rounded-2xl p-6 shadow-xl">
                    <h3 class="text-lg font-bold mb-4 flex items-center gap-2">
                        <i class="fa-solid fa-satellite-dish text-green-400 animate-pulse"></i> <span data-i18n="title_instant_report">Rapport Instantané</span>
                    </h3>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                        <div class="bg-white/10 p-4 rounded-xl backdrop-blur-sm">
                            <span class="text-slate-300 text-xs block mb-1" data-i18n="stat_status">Statut Général</span>
                            <span class="text-xl font-bold" id="report-status" data-i18n="status_waiting">En attente...</span>
                        </div>
                        <div class="bg-white/10 p-4 rounded-xl backdrop-blur-sm">
                            <span class="text-slate-300 text-xs block mb-1" data-i18n="stat_avg_speed">Vitesse Moyenne</span>
                            <span class="text-xl font-bold text-blue-400" id="report-avg-speed">0,00 T/h</span>
                        </div>
                        <div class="bg-white/10 p-4 rounded-xl backdrop-blur-sm">
                            <span class="text-slate-300 text-xs block mb-1" data-i18n="stat_min_diff">Différence Min (T)</span>
                            <span class="text-xl font-bold text-red-400" id="report-min-diff">0,00</span>
                        </div>
                        <div class="bg-white/10 p-4 rounded-xl backdrop-blur-sm">
                            <span class="text-slate-300 text-xs block mb-1" data-i18n="stat_max_diff">Différence Max (T)</span>
                            <span class="text-xl font-bold text-green-400" id="report-max-diff">0,00</span>
                        </div>
                    </div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4" id="prediction-cards"></div>

                <div class="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden">
                    <div class="p-4 border-b bg-slate-50">
                        <h3 class="font-bold flex items-center gap-2"><i class="fa-solid fa-calculator text-blue-500"></i> <span data-i18n="title_speed_details">Détails des Vitesses</span></h3>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm text-right">
                            <thead class="bg-slate-100 text-slate-600">
                                <tr>
                                    <th class="p-3 text-center" data-i18n="th_silo">Silo</th>
                                    <th class="p-3 text-center" data-i18n="th_activity">Activité</th>
                                    <th class="p-3 text-center">T/h (Inst.)</th> <th class="p-3 text-center">T/min</th>
                                    <th class="p-3 text-center">Kg/sec</th>
                                    <th class="p-3 text-center" data-i18n="th_avg_speed">Vit. Moy. T/h</th> </tr>
                            </thead>
                            <tbody id="analysisBody" class="divide-y divide-slate-100 font-mono"></tbody>
                        </table>
                    </div>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="bg-white p-4 rounded-2xl shadow-sm border h-64"><canvas id="chartWeights"></canvas></div>
                    <div class="bg-white p-4 rounded-2xl shadow-sm border h-64"><canvas id="chartDiff"></canvas></div>
                </div>
            </div>

            <div id="view-history" class="tab-content">
                <div class="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden">
                    <div class="p-4 border-b bg-slate-50 flex justify-between items-center">
                        <h3 class="font-bold text-slate-700" data-i18n="title_archive">Archive et Historique</h3>
                        <button onclick="loadUserHistory()" class="text-blue-600 hover:bg-blue-50 px-3 py-1 rounded text-sm transition" data-i18n="btn_refresh">Actualiser</button>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm text-right">
                            <thead class="bg-slate-100 text-slate-600">
                                <tr>
                                    <th class="p-4 text-center" data-i18n="th_date">التاريخ</th>
                                    <th class="p-4 text-center" data-i18n="th_total_moved">Total Mouvement</th>
                                    <th class="p-4 text-center" data-i18n="th_count">Nb. Lectures</th>
                                    <th class="p-4 text-center" data-i18n="th_avg_speed_history">Vitesse Moyenne T/h</th> <th class="p-4 text-center" data-i18n="th_actions">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="historyBody" class="divide-y divide-slate-100"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="view-settings" class="tab-content">
                
                <div class="bg-white rounded-2xl shadow-sm p-6 border border-slate-200 mb-6">
                    <h3 class="font-bold text-lg mb-4 text-slate-700" data-i18n="title_profile">الملف الشخصي</h3>
                    <form id="profileForm" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-xs font-bold text-gray-500 mb-1" data-i18n="label_firstname">الاسم الأول</label>
                            <input type="text" id="inputFirstName" class="w-full p-3 border rounded-lg bg-slate-50 outline-none focus:border-blue-500">
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-gray-500 mb-1" data-i18n="label_lastname">النسب</label>
                            <input type="text" id="inputLastName" class="w-full p-3 border rounded-lg bg-slate-50 outline-none focus:border-blue-500">
                        </div>
                        <div class="md:col-span-2">
                            <label class="block text-xs font-bold text-gray-500 mb-1" data-i18n="label_phone">الهاتف</label>
                            <input type="tel" id="inputPhone" class="w-full p-3 border rounded-lg bg-slate-50 outline-none focus:border-blue-500" dir="ltr">
                        </div>
                        <div class="md:col-span-2 text-right"> 
                            <button type="submit" class="bg-blue-600 text-white py-2 px-6 rounded-lg hover:bg-blue-700 transition font-bold shadow-lg shadow-blue-200">
                                <i class="fa-solid fa-save mx-1"></i> <span data-i18n="btn_save_settings">حفظ</span>
                            </button>
                        </div>
                    </form>
                </div>

                <div class="bg-white rounded-2xl shadow-sm p-6 border border-slate-200 mb-6">
                    <h3 class="font-bold text-lg mb-4 text-slate-700" data-i18n="title_language">Langue de l'interface</h3>
                    <div class="flex items-center gap-4">
                        <select id="languageSelect" class="w-full max-w-xs p-3 border rounded-lg bg-slate-50 outline-none focus:border-blue-500">
                            <option value="fr">Français</option>
                            <option value="en">English</option>
                            <option value="ar">العربية</option>
                        </select>
                        <button onclick="saveLanguageSetting()" class="bg-blue-600 text-white py-3 px-6 rounded-lg hover:bg-blue-700 transition font-bold">
                            <i class="fa-solid fa-save"></i> <span data-i18n="btn_save_settings">Sauvegarder</span>
                        </button>
                    </div>
                </div>

                <div class="bg-white rounded-2xl shadow-sm p-6 border border-slate-200">
                    <h3 class="font-bold text-lg mb-4" data-i18n="title_silo_settings">Réglages des Capacités des Silos</h3>
                    <div id="admin-warning" class="bg-orange-50 text-orange-600 p-3 rounded mb-4 text-sm hidden">
                        <i class="fa-solid fa-lock"></i> <span data-i18n="msg_admin_only">Admin Only</span>
                    </div>
                    <form id="settingsForm" class="space-y-4">
                        <div id="siloSettingsContainer" class="space-y-3"></div>
                        <button type="submit" id="saveSettingsBtn" class="mt-4 bg-slate-800 text-white py-2 px-6 rounded-lg hover:bg-slate-900 transition" data-i18n="btn_save_settings">Sauvegarder les Réglages</button>
                    </form>
                </div>
            </div>

        </main>
    </div>

    <div id="historyModal" class="fixed inset-0 bg-black/60 z-50 hidden flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white rounded-2xl w-full max-w-3xl max-h-[85vh] overflow-y-auto relative animate-[fadeIn_0.3s_ease-out]">
            <div class="p-6 border-b sticky top-0 bg-white z-10 flex justify-between items-center">
                <h3 class="text-xl font-bold text-slate-800" data-i18n="title_report_details">Détails du Rapport</h3>
                <button onclick="document.getElementById('historyModal').classList.add('hidden')" class="text-gray-400 hover:text-red-500 text-2xl"><i class="fa-solid fa-xmark"></i></button>
            </div>
            <div class="p-6 space-y-6">
                <div class="grid grid-cols-2 gap-4 text-sm">
                    <div class="bg-slate-50 p-3 rounded border"><span data-i18n="label_date">Date</span>: <span id="modal-date" class="font-bold"></span></div>
                    <div class="bg-slate-50 p-3 rounded border"><span data-i18n="label_total">Total</span>: <span id="modal-total" class="font-bold text-blue-600"></span></div>
                </div>
                <div>
                    <h4 class="font-bold mb-2 text-sm text-gray-500" data-i18n="label_details">Détails:</h4>
                    <div class="overflow-x-auto border rounded-lg">
                        <table class="w-full text-sm text-right">
                            <thead class="bg-gray-50 text-gray-600">
                                <tr>
                                    <th class="p-2 text-center" data-i18n="th_time">Heure</th>
                                    <th class="p-2 text-center" data-i18n="th_silo">Silo</th>
                                    <th class="p-2 text-center" data-i18n="th_weight">Poids</th>
                                    <th class="p-2 text-center"><i class="fa-solid fa-truck"></i></th>
                                    <th class="p-2 text-center" data-i18n="th_diff">Diff</th>
                                </tr>
                            </thead>
                            <tbody id="modal-records-body" class="divide-y divide-gray-100"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- TRANSLATION DATA ---
        const APP_TRANSLATIONS = {
             fr: {
                app_title: "Molino Pro",
                app_subtitle: "Système de gestion intelligent",
                email_placeholder: "Email",
                password_placeholder: "Mot de passe",
                btn_enter: "Entrer",
                btn_register: "S'inscrire",
                toggle_auth_login: "Basculer (Connexion / Inscription)",
                toggle_auth_register: "Basculer vers Connexion",
                nav_dashboard: "Surveillance",
                nav_reports: "Rapports",
                nav_archive: "Archive",
                nav_settings: "Réglages",
                title_new_entry: "Enregistrer une lecture",
                label_silo: "Silo",
                label_weight: "Poids (T)",
                label_date: "Date et heure",
                btn_record: "Enregistrer",
                title_session_log: "Journal de la session",
                th_time: "Heure",
                th_silo: "Silo",
                th_weight: "Poids",
                th_diff: "Différence",
                btn_finish: "Terminer",
                btn_analyze: "Analyse",
                title_instant_report: "Rapport Instantané",
                stat_status: "Statut Général",
                status_waiting: "En attente...",
                stat_avg_speed: "Vitesse Moyenne",
                stat_min_diff: "Différence Min",
                stat_max_diff: "Différence Max",
                title_speed_details: "Détails des Vitesses",
                th_activity: "Activité",
                th_avg_speed: "Vit. Moy. T/h",
                title_archive: "Archive et Historique",
                btn_refresh: "Actualiser",
                th_date: "Date",
                th_total_moved: "Total Mouvement",
                th_count: "Nb. Lectures",
                th_avg_speed_history: "Vit. Moy. T/h",
                th_actions: "Actions",
                title_language: "Langue de l'interface",
                btn_save_settings: "Sauvegarder",
                title_silo_settings: "Réglages des Capacités",
                msg_admin_only: "Réservé à l'administrateur",
                title_report_details: "Détails du Rapport",
                label_total: "Total",
                label_details: "Détails:",
                msg_connecting: "Connexion en cours...",
                msg_full_imminent: "Plein Imminent",
                err_capacity: "Erreur: Capacité dépassée",
                err_date_logic: "Erreur: Logique de date",
                status_filling: "Remplissage",
                status_emptying: "Vidange",
                status_active: "Actif",
                status_inactive: "Inactif",
                eta_full: "Plein dans",
                eta_empty: "Vide dans",
                msg_no_activity: "Aucune activité détectée",
                msg_start_recording: "Commencez l'enregistrement",
                msg_no_data: "Aucune donnée à enregistrer",
                msg_confirm_finish: "Voulez-vous vraiment terminer la session ?",
                msg_no_history: "Aucun historique disponible",
                btn_view_report: "Voir",
                msg_no_details: "Aucun détail disponible",
                label_rated: "Nominal",
                label_max: "Max",
                msg_no_permission: "Permission refusée",
                msg_saved: "Sauvegardé avec succès",
                msg_confirm_delete: "Supprimer cet enregistrement ?",
                label_truck: "Sortie Camion (T)",
                th_truck: "Camion",
                // Profile
                title_profile: "Profil Utilisateur",
                label_firstname: "Prénom",
                label_lastname: "Nom",
                label_phone: "Téléphone",
                msg_profile_saved: "Profil sauvegardé avec succès"
            },
            en: {
                app_title: "Molino Pro",
                app_subtitle: "Smart Management System",
                email_placeholder: "Email",
                password_placeholder: "Password",
                btn_enter: "Login",
                btn_register: "Register",
                toggle_auth_login: "Switch (Login / Register)",
                toggle_auth_register: "Switch to Login",
                nav_dashboard: "Monitor",
                nav_reports: "Reports",
                nav_archive: "Archive",
                nav_settings: "Settings",
                title_new_entry: "New Entry",
                label_silo: "Silo",
                label_weight: "Weight (T)",
                label_date: "Date & Time",
                btn_record: "Record",
                title_session_log: "Session Log",
                th_time: "Time",
                th_silo: "Silo",
                th_weight: "Weight",
                th_diff: "Diff",
                btn_finish: "Finish",
                btn_analyze: "Analyze",
                title_instant_report: "Instant Report",
                stat_status: "Status",
                status_waiting: "Waiting...",
                stat_avg_speed: "Avg Speed",
                stat_min_diff: "Min Diff",
                stat_max_diff: "Max Diff",
                title_speed_details: "Speed Details",
                th_activity: "Activity",
                th_avg_speed: "Avg Spd T/h",
                title_archive: "Archive",
                btn_refresh: "Refresh",
                th_date: "Date",
                th_total_moved: "Total Moved",
                th_count: "Count",
                th_avg_speed_history: "Avg Spd T/h",
                th_actions: "Actions",
                title_language: "Interface Language",
                btn_save_settings: "Save",
                title_silo_settings: "Silo Settings",
                msg_admin_only: "Admin Only",
                title_report_details: "Report Details",
                label_total: "Total",
                label_details: "Details:",
                msg_connecting: "Connecting...",
                msg_full_imminent: "Full Imminent",
                err_capacity: "Error: Capacity Exceeded",
                err_date_logic: "Error: Date Logic",
                status_filling: "Filling",
                status_emptying: "Emptying",
                status_active: "Active",
                status_inactive: "Inactive",
                eta_full: "Full in",
                eta_empty: "Empty in",
                msg_no_activity: "No activity detected",
                msg_start_recording: "Start recording",
                msg_no_data: "No data to save",
                msg_confirm_finish: "Finish session?",
                msg_no_history: "No history available",
                btn_view_report: "View",
                msg_no_details: "No details available",
                label_rated: "Rated",
                label_max: "Max",
                msg_no_permission: "Permission Denied",
                msg_saved: "Saved Successfully",
                msg_confirm_delete: "Delete record?",
                label_truck: "Truck Out (T)",
                th_truck: "Truck",
                // Profile
                title_profile: "User Profile",
                label_firstname: "First Name",
                label_lastname: "Last Name",
                label_phone: "Phone Number",
                msg_profile_saved: "Profile saved successfully"
            },
            ar: {
                app_title: "مولينو برو",
                app_subtitle: "نظام إدارة ذكي",
                email_placeholder: "البريد الإلكتروني",
                password_placeholder: "كلمة المرور",
                btn_enter: "دخول",
                btn_register: "تسجيل جديد",
                toggle_auth_login: "تبديل (دخول / تسجيل)",
                toggle_auth_register: "العودة للدخول",
                nav_dashboard: "المراقبة",
                nav_reports: "التقارير",
                nav_archive: "الأرشيف",
                nav_settings: "الإعدادات",
                title_new_entry: "تسجيل قراءة",
                label_silo: "الصومعة",
                label_weight: "الوزن (طن)",
                label_date: "التاريخ والوقت",
                btn_record: "حفظ",
                title_session_log: "سجل الجلسة الحالية",
                th_time: "الوقت",
                th_silo: "الصومعة",
                th_weight: "الوزن",
                th_diff: "الفرق",
                btn_finish: "إنهاء العمل",
                btn_analyze: "تحليل",
                title_instant_report: "تقرير فوري",
                stat_status: "الحالة العامة",
                status_waiting: "في الانتظار...",
                stat_avg_speed: "السرعة المتوسطة",
                stat_min_diff: "أقل فرق",
                stat_max_diff: "أعلى فرق",
                title_speed_details: "تفاصيل السرعات",
                th_activity: "النشاط",
                th_avg_speed: "م. السرعة طن/س",
                title_archive: "الأرشيف والسجل",
                btn_refresh: "تحديث",
                th_date: "التاريخ",
                th_total_moved: "إجمالي الحركة",
                th_count: "عدد القراءات",
                th_avg_speed_history: "م. السرعة طن/س",
                th_actions: "إجراءات",
                title_language: "لغة الواجهة",
                btn_save_settings: "حفظ",
                title_silo_settings: "إعدادات الصوامع",
                msg_admin_only: "للمسؤولين فقط",
                title_report_details: "تفاصيل التقرير",
                label_total: "الإجمالي",
                label_details: "التفاصيل:",
                msg_connecting: "جاري الاتصال...",
                msg_full_imminent: "امتلاء وشيك",
                err_capacity: "خطأ: تجاوز السعة",
                err_date_logic: "خطأ: ترتيب التوقيت",
                status_filling: "ملء/إنتاج",
                status_emptying: "تفريغ",
                status_active: "نشط",
                status_inactive: "خامل",
                eta_full: "ممتلئ خلال",
                eta_empty: "فارغ خلال",
                msg_no_activity: "لا يوجد نشاط",
                msg_start_recording: "ابدأ التسجيل",
                msg_no_data: "لا توجد بيانات للحفظ",
                msg_confirm_finish: "هل تريد إنهاء الجلسة حقاً؟",
                msg_no_history: "لا يوجد سجل",
                btn_view_report: "عرض",
                msg_no_details: "لا توجد تفاصيل",
                label_rated: "الاسمية",
                label_max: "القصوى",
                msg_no_permission: "غير مسموح",
                msg_saved: "تم الحفظ بنجاح",
                msg_confirm_delete: "حذف هذا السجل؟",
                label_truck: "خروج شاحنة (طن)",
                th_truck: "شاحنة",
                // Profile
                title_profile: "الملف الشخصي",
                label_firstname: "الاسم الأول",
                label_lastname: "النسب",
                label_phone: "رقم الهاتف",
                msg_profile_saved: "تم حفظ الملف الشخصي بنجاح"
            }
        };

        // --- FIREBASE CONFIGURATION ---
        const firebaseConfig = {
            apiKey: "AIzaSyCXeIS89Cd0DKz7BTsIfQDr3Ckb544dR8k",
            authDomain: "siloun.firebaseapp.com",
            databaseURL: "https://siloun-default-rtdb.firebaseio.com",
            projectId: "siloun",
            storageBucket: "siloun.firebasestorage.app",
            messagingSenderId: "111587591132",
            appId: "1:111587591132:web:0b7e481138e8885076c519"
        };
        
        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.database();

        try {
            firebase.database().enablePersistence().catch(err => console.warn("Persistence setup skipped."));
        } catch(e) { console.warn("Persistence setup skipped."); }

        const ADMIN_EMAIL = 'koreanarabione@gmail.com'; 
        let currentUser = null;
        let appSettings = { SILOS: [] };
        let currentSession = [];
        let charts = {};
        let isLoginMode = true;
        let currentLang = localStorage.getItem('molino_lang') || 'fr';
        
        function getTrans(key) {
            if (APP_TRANSLATIONS[currentLang] && APP_TRANSLATIONS[currentLang][key]) {
                return APP_TRANSLATIONS[currentLang][key];
            }
            return key; 
        }

        function updateInterfaceLanguage(lang) {
            currentLang = lang;
            document.documentElement.lang = lang;
            document.documentElement.dir = (lang === 'ar') ? 'rtl' : 'ltr';
            document.getElementById('languageSelect').value = lang;
            applyTranslations();
            updateUI(); 
        }

        function saveLanguageSetting() {
            const newLang = document.getElementById('languageSelect').value;
            localStorage.setItem('molino_lang', newLang);
            alert(getTrans('msg_saved'));
            location.reload(); 
        }

        function applyTranslations() {
            document.querySelectorAll('[data-i18n]').forEach(el => {
                const key = el.getAttribute('data-i18n');
                el.innerHTML = getTrans(key); 
            });
            document.querySelectorAll('[data-i18n-placeholder]').forEach(el => {
                const key = el.getAttribute('data-i18n-placeholder');
                el.placeholder = getTrans(key);
            });
            const authKey = isLoginMode ? 'btn_enter' : 'btn_register';
            const toggleKey = isLoginMode ? 'toggle_auth_login' : 'toggle_auth_register';
            document.getElementById('authBtn').textContent = getTrans(authKey);
            document.getElementById('authToggleText').textContent = getTrans(toggleKey);
        }

        const formatNumber = (num, decimals = 2) => {
            const locale = (currentLang === 'ar' || currentLang === 'en') ? 'en-US' : 'fr-FR';
            return new Intl.NumberFormat(locale, { minimumFractionDigits: decimals, maximumFractionDigits: decimals }).format(num);
        };
        
        const formatDate = (isoDate, options) => {
            return new Date(isoDate).toLocaleDateString('en-US', options);
        };

        // --- AUTH LOGIC ---
        auth.onAuthStateChanged(user => {
            if (user) {
                currentUser = user;
                document.getElementById('auth-view').classList.add('hidden');
                document.getElementById('app-view').classList.remove('hidden');
                document.getElementById('userEmailDisplay').textContent = user.email;
                initializeApp();
            } else {
                currentUser = null;
                document.getElementById('auth-view').classList.remove('hidden');
                document.getElementById('app-view').classList.add('hidden');
            }
        });

        function toggleAuthMode() {
            isLoginMode = !isLoginMode;
            applyTranslations(); 
        }

        document.getElementById('authForm').addEventListener('submit', e => {
            e.preventDefault();
            const email = document.getElementById('emailInput').value;
            const pass = document.getElementById('passwordInput').value;
            const msg = document.getElementById('authMessage');
            
            msg.classList.remove('hidden');
            msg.className = 'p-3 rounded text-sm font-bold bg-blue-100 text-blue-600 border border-blue-200';
            msg.textContent = getTrans('msg_connecting');

            const p = isLoginMode ? auth.signInWithEmailAndPassword(email, pass) : auth.createUserWithEmailAndPassword(email, pass);
            
            p.catch(err => {
                msg.textContent = "Error: " + err.message;
                msg.className = 'p-3 rounded text-sm font-bold bg-red-100 text-red-600 border border-red-200';
                alert(getTrans('msg_no_permission') + " / " + err.message);
            });
        });

        function logout() { auth.signOut(); }

        // --- INIT & PROFILE ---
        async function initializeApp() {
            updateInterfaceLanguage(currentLang);
            await loadSettings();
            await loadSession();
            await loadUserProfile(); // Load Profile Data
            updateUI();
            updateDateTime();
            
            const isAdmin = currentUser.email === ADMIN_EMAIL;
            document.getElementById('admin-warning').classList.toggle('hidden', isAdmin);
            const saveBtn = document.getElementById('saveSettingsBtn');
            saveBtn.disabled = !isAdmin;
            if(!isAdmin) saveBtn.classList.add('opacity-50', 'cursor-not-allowed');
            else saveBtn.classList.remove('opacity-50', 'cursor-not-allowed');
            
            setInterval(updateDateTime, 60000);
        }

        // Profile Functions
        async function saveUserProfile(e) {
            if(e) e.preventDefault();
            const firstName = document.getElementById('inputFirstName').value;
            const lastName = document.getElementById('inputLastName').value;
            const phone = document.getElementById('inputPhone').value;

            const profileData = {
                firstName: firstName,
                lastName: lastName,
                phone: phone,
                updatedAt: Date.now()
            };

            try {
                await db.ref(`molino_app_data/users/${currentUser.uid}/profile`).set(profileData);
                alert(getTrans('msg_profile_saved'));
                updateHeaderName(firstName, lastName);
            } catch (error) {
                console.error("Error saving profile:", error);
                alert("Error: " + error.message);
            }
        }

        async function loadUserProfile() {
            try {
                const snap = await db.ref(`molino_app_data/users/${currentUser.uid}/profile`).once('value');
                const data = snap.val();
                if (data) {
                    document.getElementById('inputFirstName').value = data.firstName || '';
                    document.getElementById('inputLastName').value = data.lastName || '';
                    document.getElementById('inputPhone').value = data.phone || '';
                    updateHeaderName(data.firstName, data.lastName);
                }
            } catch (error) {
                console.error("Error loading profile:", error);
            }
        }

        function updateHeaderName(first, last) {
            const emailDisplay = document.getElementById('userEmailDisplay');
            if (first || last) {
                emailDisplay.textContent = `${first || ''} ${last || ''} (${currentUser.email})`;
                emailDisplay.classList.add('font-bold', 'text-blue-600');
            } else {
                emailDisplay.textContent = currentUser.email;
            }
        }
        document.getElementById('profileForm').addEventListener('submit', saveUserProfile);

        // --- DATA LOADING ---
        function loadSettings() {
            return db.ref('molino_app_data/settings').once('value').then(snap => {
                const def = [
                    { id: 1, name: 'Siloun 1', rated: 63, max: 75 },
                    { id: 2, name: 'Siloun 2', rated: 63, max: 75 },
                    { id: 3, name: 'Siloun 3', rated: 63, max: 75 },
                    { id: 4, name: 'Siloun 4', rated: 63, max: 75 }
                ];
                appSettings.SILOS = (snap.val() && snap.val().SILOS) ? snap.val().SILOS : def;
                renderSiloSettingsInputs();
                renderGauges();
                updateSiloSelect();
            });
        }

        function loadSession() {
            return db.ref(`molino_app_data/sessions/${currentUser.uid}`).once('value').then(snap => {
                const data = snap.val();
                currentSession = data ? Object.values(data).sort((a,b) => a.ts - b.ts) : [];
            });
        }

        // --- UI UPDATES ---
        function updateUI() {
            appSettings.SILOS.forEach(silo => {
                const recs = currentSession.filter(r => r.silo === silo.name).sort((a,b) => a.ts - b.ts);
                const lastWeight = recs.length ? parseFloat(recs[recs.length-1].weight) : 0; 
                updateGauge(silo.id, lastWeight, silo.rated, silo.max);
            });
            document.getElementById('session-counter').textContent = currentSession.length;
            renderRecords();
            performLocalAnalysis();
        }

        function renderGauges() {
            document.getElementById('gauges-container').innerHTML = appSettings.SILOS.map(s => `
                <div class="bg-white p-4 rounded-xl shadow-sm border border-slate-200 relative overflow-hidden group">
                    <div class="flex justify-between mb-2 z-10 relative">
                        <span class="font-bold text-sm text-slate-700">${s.name}</span>
                        <span class="font-mono font-bold text-blue-600" id="val-${s.id}">${formatNumber(0)} T</span>
                    </div>
                    <div class="h-3 bg-slate-100 rounded-full overflow-hidden flex relative z-10">
                        <div id="bar-norm-${s.id}" class="h-full bg-blue-500 gauge-bar" style="width: 0%"></div>
                        <div id="bar-ext-${s.id}" class="h-full bg-red-500 gauge-bar" style="width: 0%"></div>
                    </div>
                    <div id="alert-${s.id}" class="hidden mt-2 text-[10px] text-red-600 font-bold bg-red-50 px-2 py-1 rounded text-center animate-pulse">
                        <i class="fa-solid fa-triangle-exclamation"></i> Full
                    </div>
                </div>
            `).join('');
        }

        function updateGauge(id, val, rated, max) {
            document.getElementById(`val-${id}`).textContent = formatNumber(val) + ' T';
            const normBar = document.getElementById(`bar-norm-${id}`);
            const extBar = document.getElementById(`bar-ext-${id}`);
            const alertBox = document.getElementById(`alert-${id}`);

            const normPercentage = Math.min(val, rated) / rated * 100;
            normBar.style.width = `${normPercentage}%`;
            
            if (normPercentage > 85) normBar.classList.replace('bg-blue-500', 'bg-yellow-500');
            else normBar.classList.replace('bg-yellow-500', 'bg-blue-500');

            if (val > rated) {
                const extValue = val - rated;
                const extCapacity = max - rated;
                const extPercentage = Math.min(extValue, extCapacity) / extCapacity * 100;
                extBar.style.width = `${extPercentage}%`;
            } else {
                extBar.style.width = '0%';
            }

            if (val >= max * 0.9) alertBox.classList.remove('hidden');
            else alertBox.classList.add('hidden');
        }

        // --- SUBMISSION LOGIC ---
        document.getElementById('entryForm').addEventListener('submit', async e => {
            e.preventDefault();
            const siloName = document.getElementById('silounSelect').value;
            const weightInput = document.getElementById('weightInput');
            const truckInput = document.getElementById('truckInput');
            const weight = parseFloat(weightInput.value);
            const truckVal = parseFloat(truckInput.value) || 0; 
            const dateVal = document.getElementById('dateTimeInput').value;

            const selectedSilo = appSettings.SILOS.find(s => s.name === siloName);

            if(!siloName || isNaN(weight) || !dateVal || !selectedSilo) return;
            
            if (weight > selectedSilo.max) {
                alert(`Error: Capacity Exceeded (${formatNumber(weight)} T > ${formatNumber(selectedSilo.max)} T)`);
                return;
            }
            
            const newTimestamp = new Date(dateVal).getTime();
            const prevRecs = currentSession.filter(r => r.silo === siloName).sort((a,b) => a.ts - b.ts);
            
            if (prevRecs.length > 0) {
                const lastTimestamp = prevRecs[prevRecs.length - 1].ts;
                if (newTimestamp < lastTimestamp) {
                    alert(getTrans('err_date_logic'));
                    return;
                }
            }

            const prevW = prevRecs.length ? parseFloat(prevRecs[prevRecs.length-1].weight) : 0;
            let diffVal = 0;
            if (prevRecs.length > 0) {
                diffVal = (weight - prevW) + truckVal;
            }

            const record = {
                id: Date.now(),
                ts: newTimestamp,
                dateStr: dateVal,
                silo: siloName,
                weight: weight,
                truck: truckVal, 
                diff: diffVal.toFixed(2)
            };

            currentSession.push(record);
            await db.ref(`molino_app_data/sessions/${currentUser.uid}/${record.id}`).set(record);
            
            updateUI();
            document.getElementById('weightInput').value = '';
            document.getElementById('truckInput').value = ''; 
        });

        function renderRecords() {
            const tbody = document.getElementById('recordsBody');
            tbody.innerHTML = [...currentSession].sort((a,b) => b.ts - a.ts).map(r => {
                const truckDisplay = r.truck && r.truck > 0 
                    ? `<span class="bg-orange-100 text-orange-700 px-2 py-1 rounded text-xs font-bold whitespace-nowrap"><i class="fa-solid fa-truck"></i> -${formatNumber(r.truck)}</span>` 
                    : '<span class="text-gray-200">-</span>';
                
                return `
                <tr class="hover:bg-slate-50 transition">
                    <td class="p-3 text-center text-gray-500">${formatDate(r.ts, { hour: '2-digit', minute: '2-digit' })}</td>
                    <td class="p-3 text-center font-bold text-slate-700">${r.silo}</td>
                    <td class="p-3 text-center" dir="ltr">${formatNumber(r.weight)}</td>
                    <td class="p-3 text-center">${truckDisplay}</td>
                    <td class="p-3 text-center font-bold ${parseFloat(r.diff) > 0 ? 'text-green-600' : parseFloat(r.diff) < 0 ? 'text-red-500' : 'text-gray-400'}" dir="ltr">${parseFloat(r.diff) > 0 ? '+' : ''}${formatNumber(r.diff)}</td>
                    <td class="p-3"><button onclick="deleteRec(${r.id})" class="text-red-300 hover:text-red-500"><i class="fa-solid fa-trash"></i></button></td>
                </tr>
            `}).join('');
        }

        async function deleteRec(id) {
            if(!confirm(getTrans('msg_confirm_delete'))) return;
            await db.ref(`molino_app_data/sessions/${currentUser.uid}/${id}`).remove();
            currentSession = currentSession.filter(r => r.id !== id);
            updateUI();
        }

        function performLocalAnalysis() {
            const labels = currentSession.map(r => formatDate(r.ts, { hour: '2-digit', minute: '2-digit' }));
            const weights = currentSession.map(r => r.weight);
            const diffs = currentSession.map(r => parseFloat(r.diff));

            let totalMoved = 0;
            let maxSpeed = 0;
            let activeSilosCount = 0;
            let totalAbsoluteWeightChange = 0;
            
            const sessionTimeHours = currentSession.length >= 2 ? (currentSession[currentSession.length - 1].ts - currentSession[0].ts) / 3600000 : 0;
            
            let minDiff = diffs.length > 0 ? Math.min(...diffs) : 0; 
            let maxDiff = diffs.length > 0 ? Math.max(...diffs) : 0; 
            
            let cardsHtml = '';
            let tableHtml = '';

            appSettings.SILOS.forEach(silo => {
                const siloRecs = currentSession.filter(r => r.silo === silo.name).sort((a,b) => a.ts - b.ts);
                
                if (siloRecs.length >= 2) {
                    const last = siloRecs[siloRecs.length - 1];
                    const prev = siloRecs[siloRecs.length - 2];
                    const first = siloRecs[0];
                    
                    const correctedDiff = parseFloat(last.diff); 
                    const timeDiffHours = (last.ts - prev.ts) / (3600000); 
                    
                    let siloTotalDiff = siloRecs.reduce((sum, r, idx) => idx > 0 ? sum + parseFloat(r.diff) : 0, 0);
                    const siloTimeDiffHours = (last.ts - first.ts) / (3600000);
                    
                    let avgSpeedTph = 0;
                    if (siloTimeDiffHours > 0) {
                        avgSpeedTph = siloTotalDiff / siloTimeDiffHours;
                    }
                    totalAbsoluteWeightChange += Math.abs(siloTotalDiff);

                    if (timeDiffHours > 0) {
                        const speedTph = correctedDiff / timeDiffHours;
                        const speedTpm = speedTph / 60;
                        const speedKgs = (speedTph * 1000) / 3600;

                        if (Math.abs(speedTph) > 0.1) {
                            activeSilosCount++;
                            if(Math.abs(speedTph) > maxSpeed) maxSpeed = Math.abs(speedTph);
                            
                            let status = '', eta = '', colorClass = '';
                            if (speedTph > 0) {
                                status = `<span class="text-green-600 font-bold">${getTrans('status_filling')}</span>`;
                                const remaining = silo.max - last.weight;
                                const hoursLeft = remaining / speedTph;
                                eta = `${getTrans('eta_full')}: ${Math.floor(hoursLeft)}h ${Math.round((hoursLeft%1)*60)}m`;
                                colorClass = 'border-l-4 border-green-500 bg-green-50/50';
                            } else {
                                status = `<span class="text-red-600 font-bold">${getTrans('status_emptying')}</span>`;
                                const hoursLeft = last.weight / Math.abs(speedTph);
                                eta = `${getTrans('eta_empty')}: ${Math.floor(hoursLeft)}h ${Math.round((hoursLeft%1)*60)}m`;
                                colorClass = 'border-l-4 border-red-500 bg-red-50/50';
                            }

                            if (last.truck > 0) {
                                status += `<div class="text-[10px] text-orange-600"><i class="fa-solid fa-truck"></i> -${last.truck}T</div>`;
                            }

                            tableHtml += `
                                <tr class="hover:bg-slate-50 transition">
                                    <td class="p-3 font-bold text-center">${silo.name}</td>
                                    <td class="p-3 text-center">${status}</td>
                                    <td class="p-3 font-mono text-center" dir="ltr">${formatNumber(speedTph)}</td>
                                    <td class="p-3 font-mono text-blue-600 text-center" dir="ltr">${formatNumber(speedTpm, 3)}</td>
                                    <td class="p-3 font-mono text-purple-600 text-center" dir="ltr">${formatNumber(speedKgs)}</td>
                                    <td class="p-3 font-mono text-yellow-600 text-center" dir="ltr">${formatNumber(avgSpeedTph)}</td> </tr>`;

                            cardsHtml += `
                                <div class="bg-white p-4 rounded-xl shadow-sm ${colorClass}">
                                    <div class="flex justify-between items-start">
                                        <h4 class="font-bold text-lg">${silo.name}</h4>
                                        <span class="text-xs bg-white px-2 py-1 rounded border" dir="ltr">${formatNumber(Math.abs(speedTph), 1)} T/h</span>
                                    </div>
                                    <div class="mt-3 text-2xl font-light text-slate-700">${eta}</div>
                                    <div class="mt-1 text-xs text-gray-500" dir="ltr">${getTrans('label_weight')}: ${formatNumber(last.weight)} T</div>
                                </div>`;
                        }
                    }
                }
            });

            let overallAvgSpeedTph = 0;
            if (sessionTimeHours > 0) {
                overallAvgSpeedTph = totalAbsoluteWeightChange / sessionTimeHours;
            }

            const statusText = activeSilosCount > 0 ? `${getTrans('status_active')} (${activeSilosCount})` : getTrans('status_inactive');
            document.getElementById('report-status').textContent = statusText;
            document.getElementById('report-avg-speed').textContent = overallAvgSpeedTph > 0 ? formatNumber(overallAvgSpeedTph) + ' T/h' : '-';
            document.getElementById('report-min-diff').textContent = formatNumber(minDiff);
            document.getElementById('report-max-diff').textContent = formatNumber(maxDiff);
            
            document.getElementById('prediction-cards').innerHTML = cardsHtml || `<div class="col-span-2 text-center text-gray-400 py-8 bg-slate-50 rounded-xl border border-dashed">${getTrans('msg_no_activity')}</div>`;
            document.getElementById('analysisBody').innerHTML = tableHtml || `<tr><td colspan="6" class="text-center p-6 text-gray-400">${getTrans('msg_start_recording')}</td></tr>`;
            
            updateCharts(labels, weights, diffs);
        }

        function updateCharts(labels, weights, diffs) {
            if (charts.w) charts.w.destroy();
            if (charts.d) charts.d.destroy();

            const ctxW = document.getElementById('chartWeights').getContext('2d');
            charts.w = new Chart(ctxW, {
                type: 'line',
                data: { labels: labels, datasets: [{ label: getTrans('th_weight'), data: weights, borderColor: '#3b82f6', tension: 0.4, pointRadius: 2 }] },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { ticks: { callback: (val) => formatNumber(val) } } } }
            });

            const ctxD = document.getElementById('chartDiff').getContext('2d');
            charts.d = new Chart(ctxD, {
                type: 'bar',
                data: { labels: labels, datasets: [{ label: 'Prod Change', data: diffs, backgroundColor: diffs.map(d => d>0?'#22c55e':'#ef4444') }] },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { ticks: { callback: (val) => formatNumber(val) } } } }
            });
        }

        async function endWork() {
            if(!currentSession.length) return alert(getTrans('msg_no_data'));
            if(!confirm(getTrans('msg_confirm_finish'))) return;

            const sessionTimeHours = currentSession.length >= 2 ? (currentSession[currentSession.length - 1].ts - currentSession[0].ts) / 3600000 : 0;
            
            let totalAbsoluteWeightChange = 0;
            appSettings.SILOS.forEach(silo => {
                const siloRecs = currentSession.filter(r => r.silo === silo.name).sort((a,b) => a.ts - b.ts);
                let siloSum = 0;
                siloRecs.forEach((r, idx) => { if(idx > 0) siloSum += Math.abs(parseFloat(r.diff)); });
                totalAbsoluteWeightChange += siloSum;
            });

            let overallAvgSpeedTph = 0;
            if (sessionTimeHours > 0) overallAvgSpeedTph = totalAbsoluteWeightChange / sessionTimeHours;
            
            const totalPos = currentSession.reduce((acc, r) => acc + (parseFloat(r.diff) > 0 ? parseFloat(r.diff) : 0), 0);
            
            const report = {
                date: new Date().toISOString(),
                totalMoved: totalPos.toFixed(2),
                recordsCount: currentSession.length,
                avgSpeedTph: overallAvgSpeedTph.toFixed(2),
                data: currentSession
            };

            await db.ref(`molino_app_data/history/${currentUser.uid}/${Date.now()}`).set(report);
            await db.ref(`molino_app_data/sessions/${currentUser.uid}`).remove();
            
            currentSession = [];
            updateUI();
            switchTab('history');
            loadUserHistory();
        }

        function loadUserHistory() {
            const tbody = document.getElementById('historyBody');
            tbody.innerHTML = '<tr><td colspan="5" class="text-center p-6"><span class="loader"></span></td></tr>';

            db.ref(`molino_app_data/history/${currentUser.uid}`).limitToLast(20).once('value').then(snap => {
                tbody.innerHTML = '';
                if(!snap.val()) { 
                    tbody.innerHTML = `<tr><td colspan="5" class="text-center p-6 text-gray-500">${getTrans('msg_no_history')}</td></tr>`;
                    return; 
                }

                Object.entries(snap.val()).reverse().forEach(([key, val]) => {
                    const displayTotal = val.totalMoved || val.total || '0.00';
                    const displayCount = val.recordsCount || (val.data ? val.data.length : 0);
                    const displayAvgSpeed = val.avgSpeedTph || '0.00';

                    tbody.innerHTML += `
                        <tr class="hover:bg-slate-50 transition border-b border-slate-100">
                            <td class="p-4 text-center text-slate-700">${formatDate(val.date, { month:'short', day:'numeric', hour: '2-digit', minute: '2-digit' })}</td>
                            <td class="p-4 text-center font-bold text-blue-600" dir="ltr">${formatNumber(displayTotal)} T</td>
                            <td class="p-4 text-center text-sm text-gray-500" dir="ltr">${displayCount}</td>
                            <td class="p-4 text-center font-bold text-purple-600" dir="ltr">${formatNumber(displayAvgSpeed)} T/h</td>
                            <td class="p-4 text-center"><button onclick='viewHistoryDetails(${JSON.stringify(val)})' class="bg-blue-50 text-blue-600 hover:bg-blue-100 px-3 py-1.5 rounded text-xs font-bold transition">${getTrans('btn_view_report')}</button></td>
                        </tr>
                    `;
                });
            });
        }

        function viewHistoryDetails(data) {
            document.getElementById('modal-date').textContent = formatDate(data.date, { year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit' });
            document.getElementById('modal-total').textContent = formatNumber(data.totalMoved || 0) + ' T';
            
            const tbody = document.getElementById('modal-records-body');
            tbody.innerHTML = '';
            
            const records = data.data || data.records || [];
            
            if(records.length > 0) {
                records.forEach(r => {
                    const truckInfo = r.truck > 0 ? `<span class="text-orange-600 font-bold text-[10px]"><i class="fa-solid fa-truck"></i> -${r.truck}</span>` : '-';
                    tbody.innerHTML += `
                        <tr>
                            <td class="p-2 text-center text-gray-500 text-xs" dir="ltr">${formatDate(r.ts, { hour: '2-digit', minute: '2-digit' })}</td>
                            <td class="p-2 text-center font-bold text-xs">${r.silo}</td>
                            <td class="p-2 text-center text-xs" dir="ltr">${formatNumber(r.weight)}</td>
                            <td class="p-2 text-center text-xs" dir="ltr">${truckInfo}</td>
                            <td class="p-2 text-center text-xs font-mono font-bold ${parseFloat(r.diff) > 0 ? 'text-green-600' : 'text-gray-400'}" dir="ltr">${formatNumber(r.diff)}</td>
                        </tr>
                    `;
                });
            } else {
                 tbody.innerHTML = `<tr><td colspan="5" class="text-center p-4">${getTrans('msg_no_details')}</td></tr>`;
            }
            
            document.getElementById('historyModal').classList.remove('hidden');
        }

        function updateSiloSelect() {
            document.getElementById('silounSelect').innerHTML = appSettings.SILOS.map(s => `<option value="${s.name}">${s.name}</option>`).join('');
        }

        function renderSiloSettingsInputs() {
            const container = document.getElementById('siloSettingsContainer');
            const isAdmin = currentUser && currentUser.email === ADMIN_EMAIL;
            container.innerHTML = appSettings.SILOS.map(s => `
                <div class="flex items-center gap-2 bg-slate-50 p-3 rounded-lg border border-slate-100">
                    <div class="w-1/3 text-sm font-bold text-slate-700">${s.name}</div>
                    <div class="w-1/3">
                        <label class="text-[10px] text-gray-400 block">${getTrans('label_rated')} (T)</label>
                        <input type="number" min="0" max="${s.max}" value="${s.rated}" data-id="${s.id}" data-key="rated" class="w-full p-1 border rounded text-sm" ${!isAdmin?'disabled':''}>
                    </div>
                    <div class="w-1/3">
                        <label class="text-[10px] text-gray-400 block">${getTrans('label_max')} (T)</label>
                        <input type="number" min="${s.rated}" value="${s.max}" data-id="${s.id}" data-key="max" class="w-full p-1 border rounded text-sm" ${!isAdmin?'disabled':''}>
                    </div>
                </div>
            `).join('');

            if (isAdmin) {
                document.querySelectorAll('#siloSettingsContainer input[data-key="rated"]').forEach(input => {
                    input.addEventListener('change', (e) => {
                        const siloId = e.target.getAttribute('data-id');
                        const ratedVal = parseFloat(e.target.value);
                        const maxInput = document.querySelector(`input[data-key="max"][data-id="${siloId}"]`);
                        if (ratedVal > parseFloat(maxInput.value)) {
                            maxInput.value = ratedVal;
                        }
                        maxInput.min = ratedVal;
                    });
                });
                document.querySelectorAll('#siloSettingsContainer input[data-key="max"]').forEach(input => {
                    input.addEventListener('change', (e) => {
                        const siloId = e.target.getAttribute('data-id');
                        const maxVal = parseFloat(e.target.value);
                        const ratedInput = document.querySelector(`input[data-key="rated"][data-id="${siloId}"]`);
                        if (maxVal < parseFloat(ratedInput.value)) {
                             e.target.value = ratedInput.value;
                        }
                        e.target.min = ratedInput.value;
                    });
                });
            }
        }

        document.getElementById('settingsForm').addEventListener('submit', async e => {
            e.preventDefault();
            if(currentUser.email !== ADMIN_EMAIL) return alert(getTrans('msg_no_permission'));
            const newSilos = appSettings.SILOS.map(s => {
                const rated = document.querySelector(`input[data-key="rated"][data-id="${s.id}"]`).value;
                const max = document.querySelector(`input[data-key="max"][data-id="${s.id}"]`).value;
                return { ...s, rated: parseFloat(rated), max: parseFloat(max) };
            });
            await db.ref('molino_app_data/settings').update({ SILOS: newSilos });
            alert(getTrans('msg_saved'));
            location.reload();
        });

        function updateDateTime() {
            const now = new Date();
            now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
            document.getElementById('dateTimeInput').value = now.toISOString().slice(0, 16);
        }

        function switchTab(tabId) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(el => {
                el.classList.remove('text-blue-600', 'border-b-2', 'border-blue-600');
                el.classList.add('text-gray-500');
            });
            document.getElementById(`view-${tabId}`).classList.add('active');
            const btn = document.getElementById(`tab-${tabId}`);
            btn.classList.remove('text-gray-500');
            btn.classList.add('text-blue-600', 'border-b-2', 'border-blue-600');
            if(tabId === 'history') loadUserHistory();
            if(tabId === 'analysis') performLocalAnalysis();
        }

        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/service-worker.js').catch(() => {});
            });
        }
    </script>
</body>
</html>
