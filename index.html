<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title data-i18n="app_title">Molino Pro - V9.1</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

    <script src="translations.js"></script>

    <style>
        body { font-family: 'Cairo', sans-serif; background-color: #f1f5f9; } 
        .tab-content { display: none; animation: fadeIn 0.3s ease-in-out; }
        .tab-content.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body class="text-gray-800">

    <div id="auth-view" class="flex justify-center items-center min-h-screen p-4 bg-gray-100 hidden">
        <div class="w-full max-w-md bg-white p-8 rounded-xl shadow-2xl">
            <h1 class="text-3xl font-bold mb-2 text-center text-blue-600" data-i18n="app_title"></h1>
            <p class="text-center text-gray-500 mb-8" data-i18n="app_subtitle"></p>
            <form id="auth-form">
                <input type="email" id="email" data-i18n-placeholder="email_placeholder" placeholder="Email" required class="w-full p-3 mb-4 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" value="test@example.com">
                <input type="password" id="password" data-i18n-placeholder="password_placeholder" placeholder="Mot de passe" required class="w-full p-3 mb-6 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" value="123456">
                
                <button type="submit" id="auth-btn" class="w-full bg-blue-600 text-white p-3 rounded-lg font-semibold hover:bg-blue-700 transition" data-i18n="btn_enter"></button>
                
                <p class="text-center mt-4 text-sm text-gray-500">
                    <button type="button" id="toggle-auth-mode" class="text-blue-600 hover:text-blue-700 font-medium" data-i18n="toggle_auth_login"></button>
                </p>
            </form>
            <p id="auth-message" class="mt-4 text-center text-red-500 hidden"></p>
        </div>
    </div>

    <div id="app-view" class="min-h-screen bg-white shadow-lg hidden">
        
        <header class="bg-white border-b sticky top-0 z-10">
            <div class="container mx-auto px-4 py-4 flex justify-between items-center">
                <h1 class="text-2xl font-bold text-blue-600" data-i18n="app_title"></h1>
                <div class="flex items-center space-x-4 space-x-reverse">
                    <button onclick="logout()" class="text-red-500 hover:text-red-700 transition" title="Logout"><i class="fa-solid fa-sign-out-alt"></i></button>
                    <button onclick="switchLang()" class="text-gray-500 hover:text-blue-600 transition" title="Switch Language"><i class="fa-solid fa-language"></i></button>
                    <button onclick="switchTab('settings')" id="tab-settings" class="text-gray-500 hover:text-blue-600 transition tab-btn" title="Settings"><i class="fa-solid fa-cog"></i></button>
                </div>
            </div>
            <nav class="container mx-auto px-4 flex border-t border-gray-200">
                <button onclick="switchTab('record')" id="tab-record" class="tab-btn p-3 text-blue-600 border-b-2 border-blue-600 font-semibold" data-i18n="tab_record"></button>
                <button onclick="switchTab('analysis')" id="tab-analysis" class="tab-btn p-3 text-gray-500 font-semibold" data-i18n="tab_analysis"></button>
                <button onclick="switchTab('history')" id="tab-history" class="tab-btn p-3 text-gray-500 font-semibold" data-i18n="tab_history"></button>
            </nav>
        </header>

        <main class="container mx-auto px-4 py-6">
            
            <div id="view-record" class="tab-content active bg-white p-6 rounded-xl shadow-lg">
                <h2 class="text-2xl font-semibold mb-4 text-blue-600" data-i18n="title_record_new"></h2>
                
                <form id="entry-form" class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6 p-4 border rounded-lg bg-gray-50">
                    <div>
                        <label for="weightInput" class="block text-sm font-medium text-gray-700" data-i18n="label_weight"></label>
                        <input type="number" id="weightInput" step="0.01" required class="mt-1 w-full p-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div>
                        <label for="siloSelect" class="block text-sm font-medium text-gray-700" data-i18n="label_silo"></label>
                        <select id="siloSelect" required class="mt-1 w-full p-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                            </select>
                    </div>
                    <div>
                        <label for="dateInput" class="block text-sm font-medium text-gray-700" data-i18n="label_date"></label>
                        <input type="datetime-local" id="dateInput" required class="mt-1 w-full p-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div class="flex items-end">
                        <button type="submit" class="w-full bg-green-500 text-white p-2.5 rounded-lg font-semibold hover:bg-green-600 transition" data-i18n="btn_record"></button>
                    </div>
                    <div id="entry-message" class="md:col-span-4 text-red-500 hidden font-medium"></div>
                </form>

                <div class="mt-8">
                    <h3 class="text-xl font-semibold mb-4" data-i18n="title_session_log"></h3>
                    <div class="overflow-x-auto border rounded-lg">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="p-3 text-right text-xs font-medium text-gray-500 uppercase" data-i18n="th_time"></th>
                                    <th class="p-3 text-right text-xs font-medium text-gray-500 uppercase" data-i18n="th_silo"></th>
                                    <th class="p-3 text-right text-xs font-medium text-gray-500 uppercase" data-i18n="th_weight"></th>
                                    <th class="p-3 text-right text-xs font-medium text-gray-500 uppercase" data-i18n="th_diff"></th>
                                    <th class="p-3 text-right text-xs font-medium text-gray-500 uppercase" data-i18n="th_actions"></th>
                                </tr>
                            </thead>
                            <tbody id="session-log-body" class="bg-white divide-y divide-gray-200">
                                </tbody>
                        </table>
                    </div>
                    
                    <div class="mt-6 flex justify-end">
                        <button id="finish-session-btn" class="bg-blue-600 text-white p-3 rounded-lg font-semibold hover:bg-blue-700 transition" data-i18n="btn_finish"></button>
                    </div>
                </div>
            </div>
            
            <div id="view-analysis" class="tab-content">
                <h2 class="text-2xl font-semibold mb-4 text-blue-600" data-i18n="title_instant_report"></h2>
                </div>

            <div id="view-history" class="tab-content">
                <h2 class="text-2xl font-semibold mb-4 text-blue-600" data-i18n="title_archive"></h2>
                </div>
            
            <div id="view-settings" class="tab-content">
                <h2 class="text-2xl font-semibold mb-4 text-blue-600" data-i18n="title_settings"></h2>
                </div>

        </main>
        
    </div>

    <script>
        // المتغيرات العامة
        let currentUser = null;
        let currentSession = [];
        let allSiloCapacities = {};
        let currentLang = 'ar';
        const siloNames = ['Silo-A', 'Silo-B', 'Silo-C', 'Silo-D']; // قائمة الصوامع الافتراضية

        // 1. وظيفة تطبيق الترجمة
        function applyTranslations() {
            const elements = document.querySelectorAll('[data-i18n]');
            elements.forEach(el => {
                const key = el.getAttribute('data-i18n');
                if (APP_TRANSLATIONS[currentLang] && APP_TRANSLATIONS[currentLang][key]) {
                    el.textContent = APP_TRANSLATIONS[currentLang][key];
                }
            });
            const placeholders = document.querySelectorAll('[data-i18n-placeholder]');
             placeholders.forEach(el => {
                const key = el.getAttribute('data-i18n-placeholder');
                if (APP_TRANSLATIONS[currentLang] && APP_TRANSLATIONS[currentLang][key]) {
                    el.placeholder = APP_TRANSLATIONS[currentLang][key];
                }
            });
            document.documentElement.dir = currentLang === 'ar' ? 'rtl' : 'ltr';
            document.documentElement.lang = currentLang;
        }

        function getTrans(key) {
             return (APP_TRANSLATIONS[currentLang] && APP_TRANSLATIONS[currentLang][key]) || key;
        }

        // 2. تهيئة Firebase
        const firebaseConfig = {
            // ** مهم: ضع إعدادات Firebase الخاصة بك هنا **
            apiKey: "YOUR_API_KEY",
            authDomain: "YOUR_PROJECT_ID.firebaseapp.com",
            databaseURL: "https://YOUR_PROJECT_ID-default-rtdb.firebaseio.com",
            projectId: "YOUR_PROJECT_ID",
            storageBucket: "YOUR_PROJECT_ID.appspot.com",
            messagingSenderId: "SENDER_ID",
            appId: "APP_ID"
        }; 
        
        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        const db = firebase.database();
        const auth = firebase.auth();
        
        // ** ⬅️ التعديل رقم 1: تفعيل وضع عدم الاتصال (Persistence) **
        // يجب أن يتم تفعيلها فوراً بعد التهيئة وقبل أي عملية قراءة/كتابة
        firebase.database().enablePersistence()
            .then(() => {
                console.log("Firebase Persistence Enabled. Offline data entry is supported.");
            })
            .catch(err => {
                if (err.code == 'failed-precondition') {
                    console.warn("Firebase Persistence: Cannot enable, likely due to multiple tabs.");
                } else if (err.code == 'unimplemented') {
                    console.warn("Firebase Persistence: Not supported on this browser.");
                } else {
                    console.error("Firebase Persistence Error:", err);
                }
            });
        // ----------------------------------------------------

        // 3. وظائف واجهة المستخدم الأساسية
        function formatTimestamp(ts) {
            const date = new Date(ts * 1000);
            return date.toLocaleString(currentLang, { dateStyle: 'short', timeStyle: 'short' });
        }
        
        function populateSiloSelect() {
            const select = document.getElementById('siloSelect');
            select.innerHTML = siloNames.map(name => `<option value="${name}">${name}</option>`).join('');
            document.getElementById('dateInput').valueAsNumber = Date.now() - (new Date().getTimezoneOffset() * 60000); // التاريخ الحالي
        }
        
        function switchTab(tabId) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(el => {
                el.classList.remove('text-blue-600', 'border-b-2', 'border-blue-600');
                el.classList.add('text-gray-500');
            });
            document.getElementById(`view-${tabId}`).classList.add('active');
            const btn = document.getElementById(`tab-${tabId}`);
            btn.classList.remove('text-gray-500');
            btn.classList.add('text-blue-600', 'border-b-2', 'border-blue-600');
            
            //if(tabId === 'history') loadUserHistory(); // وظائف غير موجودة حالياً
            //if(tabId === 'analysis') performLocalAnalysis(); // وظائف غير موجودة حالياً
        }
        
        function switchLang() {
            currentLang = currentLang === 'ar' ? 'fr' : 'ar';
            applyTranslations();
        }
        
        function updateUI() {
            renderRecords();
            // يمكنك إضافة وظائف تحديث الشارتات والتحليل هنا
        }
        
        // 4. دالة عرض السجلات
        function renderRecords() {
            const tbody = document.getElementById('session-log-body');
            const sortedRecords = [...currentSession].sort((a,b) => b.ts - a.ts);

            tbody.innerHTML = sortedRecords.map(r => {
                const diffColor = parseFloat(r.diff) > 0 ? 'text-green-500' : (parseFloat(r.diff) < 0 ? 'text-red-500' : 'text-gray-500');
                
                // ** ⬅️ التعديل رقم 3: تمرير ID كـ (string) محاط بعلامتي تنصيص **
                return `
                    <tr class="hover:bg-slate-50 transition">
                        <td class="p-3">${formatTimestamp(r.ts)}</td>
                        <td class="p-3">${r.silo}</td>
                        <td class="p-3">${r.weight} ط</td>
                        <td class="p-3 ${diffColor}">${r.diff} ط</td>
                        <td class="p-3">
                            <button onclick="deleteRec('${r.id}')" class="text-red-300 hover:text-red-500">
                                <i class="fa-solid fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');
        }
        
        // 5. دالة حذف السجل
        // ** ⬅️ التعديل رقم 4: إزالة async واستخدام key كمتغير (نصي) **
        function deleteRec(key) { 
            if(!confirm(getTrans('msg_confirm_delete') || 'Delete?')) return;
            
            // 1. إزالة البيانات من قاعدة بيانات Firebase (بدون انتظار/await)
            // سيتولى Persistence الأمر في الخلفية
            db.ref(`molino_app_data/sessions/${currentUser.uid}/${key}`).remove()
              .catch(error => console.error("Firebase remove operation failed:", error));

            // 2. فلترة البيانات محلياً (باستخدام المفتاح النصي)
            currentSession = currentSession.filter(r => r.id !== key);
            
            // 3. تحديث واجهة المستخدم فوراً
            updateUI();
        }
        // ----------------------------------------------------

        // 6. تحميل الجلسة الحالية
        function loadCurrentSession(uid) {
            // استخدام once('value') لمرة واحدة لضمان تزامن التحميل الأولي
            db.ref(`molino_app_data/current_session/${uid}`).once('value')
                .then(snapshot => {
                    const data = snapshot.val();
                    currentSession = data ? Object.values(data) : [];
                    updateUI();
                })
                .catch(error => console.error("Error loading current session:", error));
        }

        // 7. تسجيل الخروج
        function logout() {
            auth.signOut();
            currentSession = [];
            updateAuthView(false);
        }

        // 8. منطق المصادقة (Auth State)
        auth.onAuthStateChanged(user => {
            if (user) {
                currentUser = user;
                loadCurrentSession(user.uid);
                updateAuthView(true);
            } else {
                currentUser = null;
                updateAuthView(false);
            }
        });
        
        function updateAuthView(isLoggedIn) {
            document.getElementById('auth-view').classList.toggle('hidden', isLoggedIn);
            document.getElementById('app-view').classList.toggle('hidden', !isLoggedIn);
            if (isLoggedIn) {
                populateSiloSelect();
                switchTab('record');
            }
        }
        
        // 9. معالجة نموذج التسجيل (Form Submission)
        const entryForm = document.getElementById('entry-form');
        
        // ** ⬅️ التعديل رقم 2: تحديث منطق حفظ السجل ليدعم وضع عدم الاتصال **
        entryForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const weight = parseFloat(document.getElementById('weightInput').value);
            const siloName = document.getElementById('siloSelect').value;
            const dateVal = document.getElementById('dateInput').value;
            const newTimestamp = Date.parse(dateVal) / 1000;
            const entryMessage = document.getElementById('entry-message');
            entryMessage.classList.add('hidden');

            // 1. التحقق من منطق الوقت
            const prevRecs = currentSession.filter(r => r.silo === siloName);
            if (prevRecs.length > 0 && newTimestamp <= prevRecs[prevRecs.length-1].ts) {
                 entryMessage.textContent = getTrans('err_date_logic');
                 entryMessage.classList.remove('hidden');
                 return;
            }
            
            // 2. حساب الفرق
            const prevW = prevRecs.length ? parseFloat(prevRecs[prevRecs.length-1].weight) : 0;
            const diff = prevRecs.length ? (weight - prevW).toFixed(2) : '0.00';

            let record = {
                ts: newTimestamp,
                dateStr: dateVal,
                silo: siloName,
                weight: weight,
                diff: diff
                // سيتم إضافة ID لاحقاً باستخدام مفتاح Firebase
            };
            
            // 3. إنشاء مفتاح فريد والدفع المحلي (Offline-First)
            const newRecordRef = db.ref(`molino_app_data/sessions/${currentUser.uid}`).push();
            record.id = newRecordRef.key; // تعيين مفتاح Firebase كنظام تعريف محلي
            
            currentSession.push(record); // الدفع محلياً أولاً
            
            // 4. الحفظ في Firebase دون استخدام await
            // هذا يسمح للكود بالاستمرار فوراً ويجعل Firebase Persistence مسؤولاً عن المزامنة.
            newRecordRef.set(record)
                .then(() => {
                    console.log("Record saved (offline persistence or server).");
                })
                .catch(error => {
                    // هذا سيُسجَّل فقط في حال فشل الحفظ المحلي/البعيد بشكل حرج
                    console.error("Firebase save operation failed:", error);
                });

            // 5. تحديث واجهة المستخدم
            updateUI();
            document.getElementById('weightInput').value = '';
        });
        // ----------------------------------------------------

        // 10. معالجة نموذج المصادقة (Auth Form)
        const authForm = document.getElementById('auth-form');
        authForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const authBtn = document.getElementById('auth-btn');
            const toggleBtn = document.getElementById('toggle-auth-mode');
            const isRegisterMode = authBtn.dataset.mode === 'register';
            const message = document.getElementById('auth-message');
            
            message.textContent = getTrans('msg_connecting');
            message.classList.remove('hidden');
            authBtn.disabled = true;
            toggleBtn.disabled = true;

            try {
                if (isRegisterMode) {
                    await auth.createUserWithEmailAndPassword(email, password);
                } else {
                    await auth.signInWithEmailAndPassword(email, password);
                }
                message.classList.add('hidden');
            } catch (error) {
                message.textContent = `Error: ${error.message}`;
                message.classList.remove('hidden');
            } finally {
                authBtn.disabled = false;
                toggleBtn.disabled = false;
            }
        });
        
        // 11. تبديل وضع المصادقة
        document.getElementById('toggle-auth-mode').addEventListener('click', (e) => {
            const authBtn = document.getElementById('auth-btn');
            const isRegisterMode = authBtn.dataset.mode === 'register';
            authBtn.dataset.mode = isRegisterMode ? 'login' : 'register';
            authBtn.textContent = isRegisterMode ? getTrans('btn_enter') : getTrans('btn_register');
            e.target.textContent = isRegisterMode ? getTrans('toggle_auth_login') : getTrans('toggle_auth_register');
            document.getElementById('auth-message').classList.add('hidden');
        });

        // 12. تسجيل الـ Service Worker (كما في ملفك الأصلي)
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/service-worker.js')
                    .then(registration => {
                        console.log('Service Worker registered successfully with scope: ', registration.scope);
                    })
                    .catch(registrationError => {
                        console.log('Service Worker registration failed: ', registrationError);
                    });
            });
        }
        
        // تطبيق الترجمة الافتراضية عند التحميل
        applyTranslations();
        
    </script>
</body>
</html>
