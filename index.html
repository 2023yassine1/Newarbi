<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Molino App - ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¥Ù†ØªØ§Ø¬</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

    <style>
        body { font-family: 'Cairo', sans-serif; background-color: #f8fafc; }
        .data-row:nth-child(even) { background-color: #f8fafc; }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 min-h-screen" dir="rtl">

    <div id="auth-view" class="fixed inset-0 bg-slate-900 z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl p-8 w-full max-w-md text-center border-t-4 border-blue-600">
            <h1 class="text-3xl font-bold text-slate-800 mb-2">ØªØ³Ø¬ÙŠÙ„ Ø¥Ù†ØªØ§Ø¬ <span class="text-blue-600">Ù…ÙˆÙ„ÙŠÙ†Ùˆ</span></h1>
            <p class="text-gray-500 mb-6">Ø§Ù„Ø±Ø¬Ø§Ø¡ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù„Ù„Ø¨Ø¯Ø¡ Ø¨Ø§Ù„Ø¹Ù…Ù„</p>
            
            <form id="authForm" class="space-y-4">
                <input type="email" id="emailInput" placeholder="Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ" required class="w-full p-3 border rounded-lg outline-none focus:ring-2 focus:ring-blue-500" dir="ltr">
                <input type="password" id="passwordInput" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±" required class="w-full p-3 border rounded-lg outline-none focus:ring-2 focus:ring-blue-500" dir="ltr">
                <div id="authMessage" class="hidden p-3 rounded text-sm font-bold bg-red-100 text-red-600"></div>
                <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-lg transition">Ø¯Ø®ÙˆÙ„</button>
            </form>
            <p class="text-xs text-gray-400 mt-4">Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¯Ø®ÙˆÙ„ØŒ ÙŠØ±Ø¬Ù‰ Ù…Ø±Ø§Ø¬Ø¹Ø© Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…ØµÙ†Ø¹.</p>
        </div>
    </div>

    <div id="app-view" class="hidden">
        
        <header class="bg-blue-600 text-white shadow-lg sticky top-0 z-40">
            <div class="max-w-4xl mx-auto px-4 py-3 flex justify-between items-center">
                <div class="flex items-center gap-3">
                    <i class="fa-solid fa-industry text-xl"></i>
                    <h1 class="text-xl font-bold">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¥Ù†ØªØ§Ø¬</h1>
                </div>
                <div class="flex items-center gap-4">
                    <span id="userEmailDisplay" class="text-sm font-mono text-blue-100 hidden md:inline"></span>
                    <button onclick="logout()" class="bg-blue-700 hover:bg-blue-800 px-3 py-1 rounded-lg text-sm font-bold transition">Ø®Ø±ÙˆØ¬</button>
                </div>
            </div>
        </header>

        <main class="max-w-4xl mx-auto p-4">
            
            <div id="status-card" class="bg-white rounded-xl shadow-lg p-6 mb-6 text-center border-t-4 border-blue-500">
                <p id="status-message" class="text-lg font-bold text-gray-700 mb-4">Ù„Ù… ÙŠØªÙ… Ø¨Ø¯Ø¡ Ø§Ù„Ø¹Ù…Ù„ Ø¨Ø¹Ø¯.</p>
                <button id="start-work-btn" onclick="startWork()" class="bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-8 rounded-full shadow-md transition">
                    <i class="fa-solid fa-play mx-2"></i> Ø¨Ø¯Ø¡ ÙˆØ±Ø¯ÙŠØ© Ø§Ù„Ø¹Ù…Ù„
                </button>
                <div id="session-timer" class="text-2xl font-mono text-blue-600 mt-3 hidden" dir="ltr">00:00:00</div>
            </div>

            <div id="data-entry-form" class="bg-white rounded-xl shadow-lg p-6 hidden">
                <h2 class="text-xl font-bold text-slate-800 mb-4 border-b pb-2">ØªØ³Ø¬ÙŠÙ„ Ù‚Ø±Ø§Ø¡Ø© Ø¬Ø¯ÙŠØ¯Ø©</h2>
                
                <div class="grid grid-cols-2 gap-4 mb-4">
                    <div>
                        <label for="siloInput" class="block text-sm font-medium text-gray-700 mb-1">Ø§Ø³Ù… Ø§Ù„ØµÙˆÙ…Ø¹Ø©/Ø§Ù„Ø®Ø§Ù…</label>
                        <input type="text" id="siloInput" placeholder="Ù…Ø«Ù„: ØµÙˆÙ…Ø¹Ø© 1ØŒ ÙØ­Ù…" class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-blue-500" required>
                    </div>
                    <div>
                        <label for="weightInput" class="block text-sm font-medium text-gray-700 mb-1">Ø§Ù„ÙˆØ²Ù† Ø§Ù„Ø­Ø§Ù„ÙŠ (Ø·Ù†)</label>
                        <input type="number" id="weightInput" placeholder="1234.50" step="0.01" class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-blue-500" required>
                    </div>
                </div>

                <button onclick="recordWeight()" class="w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 rounded-lg transition">
                    <i class="fa-solid fa-save mx-2"></i> ØªØ³Ø¬ÙŠÙ„ ÙˆØ­ÙØ¸ Ø§Ù„Ù‚Ø±Ø§Ø¡Ø©
                </button>
                
                <div id="truck-container" class="mt-4 p-3 bg-yellow-50 rounded-lg border border-yellow-200">
                    <label for="truckInput" class="block text-sm font-medium text-gray-700 mb-1">ÙˆØ²Ù† Ø§Ù„Ø´Ø§Ø­Ù†Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
                    <input type="number" id="truckInput" placeholder="0.00" step="0.01" class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-yellow-500">
                </div>
            </div>

            <div id="summary-section" class="mt-6 hidden">
                <h2 class="text-xl font-bold text-slate-800 mb-4 border-b pb-2">Ù…Ù„Ø®Øµ Ø§Ù„Ø¬Ù„Ø³Ø©</h2>
                
                <div class="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-6 text-center">
                    <div class="bg-white p-4 rounded-lg shadow border-l-4 border-green-500">
                        <p class="text-sm text-gray-500">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…ÙÙ†ØªØ¬ (Ø·Ù†)</p>
                        <p id="total-moved" class="text-2xl font-bold text-green-600" dir="ltr">0.00 T</p>
                    </div>
                    <div class="bg-white p-4 rounded-lg shadow border-l-4 border-blue-500">
                        <p class="text-sm text-gray-500">Ø¹Ø¯Ø¯ Ø§Ù„Ù‚Ø±Ø§Ø¡Ø§Øª</p>
                        <p id="readings-count" class="text-2xl font-bold text-blue-600">0</p>
                    </div>
                    <div class="bg-white p-4 rounded-lg shadow border-l-4 border-purple-500">
                        <p class="text-sm text-gray-500">Ø³Ø±Ø¹Ø© Ø§Ù„Ø¥Ù†ØªØ§Ø¬ (T/h)</p>
                        <p id="avg-speed" class="text-2xl font-bold text-purple-600" dir="ltr">0.00</p>
                    </div>
                    <div class="bg-white p-4 rounded-lg shadow border-l-4 border-orange-500">
                        <p class="text-sm text-gray-500">Ø´Ø§Ø­Ù†Ø§Øª Ù…Ø³Ø¬Ù„Ø© (Ø·Ù†)</p>
                        <p id="total-trucks" class="text-2xl font-bold text-orange-600" dir="ltr">0.00 T</p>
                    </div>
                </div>

                <div class="overflow-x-auto bg-white rounded-lg shadow-md mb-6">
                    <table class="min-w-full text-sm text-right">
                        <thead class="bg-slate-100 text-slate-600 uppercase text-xs">
                            <tr>
                                <th class="p-3">Ø§Ù„ÙˆÙ‚Øª</th>
                                <th class="p-3">Ø§Ù„ØµÙˆÙ…Ø¹Ø©</th>
                                <th class="p-3">Ø§Ù„ÙˆØ²Ù† Ø§Ù„Ù…Ø³Ø¬Ù„</th>
                                <th class="p-3 text-center">ÙØ±Ù‚ Ø§Ù„Ø¥Ù†ØªØ§Ø¬</th>
                            </tr>
                        </thead>
                        <tbody id="readings-table-body" class="divide-y divide-slate-200">
                            </tbody>
                    </table>
                </div>

                <button onclick="endWork()" class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-3 rounded-lg transition shadow-xl">
                    <i class="fa-solid fa-stop-circle mx-2"></i> Ø¥Ù†Ù‡Ø§Ø¡ ÙˆØ±Ø¯ÙŠØ© Ø§Ù„Ø¹Ù…Ù„ ÙˆØ¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªÙ‚Ø±ÙŠØ±
                </button>
            </div>
        </main>
    </div>

    <script>
        // ----------------------------------------------------------------------
        // ğŸš¨ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Firebase (ÙŠØ¬Ø¨ Ø§Ø³ØªØ¨Ø¯Ø§Ù„Ù‡Ø§ Ø¨Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ù…Ø´Ø±ÙˆØ¹Ùƒ Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠØ©)
        // ----------------------------------------------------------------------
        const firebaseConfig = {
            apiKey: "AIzaSyCXeIS89Cd0DKz7BTsIfQDr3Ckb544dR8k", // Placeholder
            authDomain: "siloun.firebaseapp.com",
            databaseURL: "https://siloun-default-rtdb.firebaseio.com",
            projectId: "siloun",
            storageBucket: "siloun.firebasestorage.app",
            messagingSenderId: "111587591132",
            appId: "1:111587591132:web:0b7e481138e8885076c519"
        };
        
        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        
        const auth = firebase.auth();
        const db = firebase.database();
        
        // ØªÙ…ÙƒÙŠÙ† Ø§Ø³ØªÙ…Ø±Ø§Ø±ÙŠØ© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ©
        try {
            firebase.database().enablePersistence().catch(err => {
                if(err.code === 'failed-precondition') console.warn("Persistence: Multiple tabs open.");
                else if(err.code === 'unimplemented') console.warn("Persistence: Not supported.");
            });
        } catch(e) { 
            console.warn("Persistence setup skipped."); 
        }
        
        // --- Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø¹Ø§Ù…Ø© ---
        let currentUser = null;
        let currentSession = []; 
        let currentLastWeight = 0;
        let sessionTimerInterval = null;
        let sessionStartTime = null;

        // --- AUTHENTICATION LOGIC ---
        auth.onAuthStateChanged(user => {
            if (user) {
                currentUser = user;
                document.getElementById('auth-view').classList.add('hidden');
                document.getElementById('app-view').classList.remove('hidden');
                document.getElementById('userEmailDisplay').textContent = user.email;
                loadSession();
            } else {
                currentUser = null;
                document.getElementById('auth-view').classList.remove('hidden');
                document.getElementById('app-view').classList.add('hidden');
                resetSessionState();
            }
        });

        document.getElementById('authForm').addEventListener('submit', e => {
            e.preventDefault();
            const email = document.getElementById('emailInput').value;
            const pass = document.getElementById('passwordInput').value;
            auth.signInWithEmailAndPassword(email, pass).catch(err => {
                const msg = document.getElementById('authMessage');
                msg.classList.remove('hidden');
                msg.textContent = "Ø®Ø·Ø£: " + err.message;
            });
        });

        function logout() {
            auth.signOut();
        }
        
        // --- SESSION MANAGEMENT ---
        function resetSessionState() {
            currentSession = [];
            currentLastWeight = 0;
            sessionStartTime = null;
            if (sessionTimerInterval) clearInterval(sessionTimerInterval);
            
            document.getElementById('status-message').textContent = 'Ù„Ù… ÙŠØªÙ… Ø¨Ø¯Ø¡ Ø§Ù„Ø¹Ù…Ù„ Ø¨Ø¹Ø¯.';
            document.getElementById('start-work-btn').classList.remove('hidden');
            document.getElementById('session-timer').classList.add('hidden');
            document.getElementById('data-entry-form').classList.add('hidden');
            document.getElementById('summary-section').classList.add('hidden');
            updateSummaryDisplay();
        }

        function loadSession() {
            db.ref(`molino_app_data/sessions/${currentUser.uid}`).once('value').then(snapshot => {
                const data = snapshot.val();
                if (data && data.session && data.session.length > 0) {
                    currentSession = data.session;
                    currentLastWeight = currentSession[currentSession.length - 1].weight;
                    sessionStartTime = new Date(currentSession[0].ts).getTime();
                    
                    document.getElementById('status-message').textContent = 'Ø§Ù„Ø¹Ù…Ù„ Ù‚ÙŠØ¯ Ø§Ù„ØªÙ‚Ø¯Ù…...';
                    document.getElementById('start-work-btn').classList.add('hidden');
                    document.getElementById('session-timer').classList.remove('hidden');
                    document.getElementById('data-entry-form').classList.remove('hidden');
                    document.getElementById('summary-section').classList.remove('hidden');
                    
                    startTimer();
                    updateSummaryDisplay();
                } else {
                    resetSessionState();
                }
            });
        }
        
        async function startWork() {
            // ØªØ­Ù‚Ù‚ Ù…Ù† Ø¹Ø¯Ù… ÙˆØ¬ÙˆØ¯ Ø¬Ù„Ø³Ø© Ù‚Ø§Ø¦Ù…Ø©
            if (currentSession.length > 0) return; 

            // Ø­ÙØ¸ Ø£ÙˆÙ„ Ù‚Ø±Ø§Ø¡Ø© Ù„ÙˆØ²Ù† ÙˆÙ‡Ù…ÙŠ Ø£Ùˆ Ø§ÙØªØ±Ø§Ø¶ÙŠ Ù„Ø¨Ø¯Ø¡ Ø§Ù„Ø¬Ù„Ø³Ø©
            currentSession = [{
                ts: Date.now(),
                silo: 'START',
                weight: 0,
                diff: 0,
                truck: 0 
            }];
            currentLastWeight = 0; 
            sessionStartTime = currentSession[0].ts;

            // Ø­ÙØ¸ Ø§Ù„Ø­Ø§Ù„Ø© ÙÙŠ Firebase
            await db.ref(`molino_app_data/sessions/${currentUser.uid}`).set({
                session: currentSession
            });

            loadSession(); // Ù„Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© Ø¨Ø¹Ø¯ Ø§Ù„Ø¨Ø¯Ø¡
        }

        async function recordWeight() {
            const silo = document.getElementById('siloInput').value.trim();
            const weightStr = document.getElementById('weightInput').value;
            const truckStr = document.getElementById('truckInput').value || "0";
            
            if (!silo || !weightStr) {
                alert("Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ø§Ù„ØµÙˆÙ…Ø¹Ø© ÙˆØ§Ù„ÙˆØ²Ù†.");
                return;
            }

            const newWeight = parseFloat(weightStr);
            const truckWeight = parseFloat(truckStr);
            
            if (isNaN(newWeight) || newWeight < 0) {
                alert("Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ ÙˆØ²Ù† ØµØ§Ù„Ø­.");
                return;
            }
            if (newWeight < currentLastWeight) {
                alert("Ø§Ù„ÙˆØ²Ù† Ø§Ù„Ø­Ø§Ù„ÙŠ Ø£Ù‚Ù„ Ù…Ù† Ø§Ù„ÙˆØ²Ù† Ø§Ù„Ø³Ø§Ø¨Ù‚. ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ù‚Ø±Ø§Ø¡Ø©.");
                return;
            }

            // Ø­Ø³Ø§Ø¨ ÙØ±Ù‚ Ø§Ù„Ø¥Ù†ØªØ§Ø¬ (Ø§Ù„ØªØºÙŠÙŠØ± Ø§Ù„Ø¥ÙŠØ¬Ø§Ø¨ÙŠ ÙÙ‚Ø·)
            const weightDiff = newWeight - currentLastWeight;
            const productionDiff = (weightDiff > 0) ? weightDiff : 0; 

            const newRecord = {
                ts: Date.now(),
                silo: silo,
                weight: newWeight,
                diff: productionDiff.toFixed(2),
                truck: truckWeight.toFixed(2)
            };

            currentSession.push(newRecord);
            currentLastWeight = newWeight;

            // ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø¬Ù„Ø³Ø© ÙÙŠ Firebase
            await db.ref(`molino_app_data/sessions/${currentUser.uid}`).set({
                session: currentSession
            });

            // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„ ÙˆØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
            document.getElementById('siloInput').value = '';
            document.getElementById('weightInput').value = '';
            document.getElementById('truckInput').value = '';
            updateSummaryDisplay();
        }

        // ----------------------------------------------------------------------
        // ğŸš¨ Ø¯Ø§Ù„Ø© Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ø¹Ù…Ù„: ÙŠØªÙ… Ù‡Ù†Ø§ Ø­ÙØ¸ Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„
        // ----------------------------------------------------------------------
        async function endWork() {
            if (currentSession.length < 2) {
                alert("Ù„Ø§ ØªÙˆØ¬Ø¯ Ù‚Ø±Ø§Ø¡Ø§Øª ÙƒØ§ÙÙŠØ© Ù„Ø­ÙØ¸ Ø§Ù„ØªÙ‚Ø±ÙŠØ±.");
                return;
            }

            const sessionDurationMs = Date.now() - sessionStartTime;
            const sessionDurationHours = sessionDurationMs / 3600000;
            
            // Ø­Ø³Ø§Ø¨ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¥Ù†ØªØ§Ø¬ (Ø§Ù„ÙØ±Ù‚ Ø§Ù„Ø¥ÙŠØ¬Ø§Ø¨ÙŠ)
            const totalPos = currentSession.reduce((acc, r) => acc + (parseFloat(r.diff) || 0), 0);
            
            // Ø­Ø³Ø§Ø¨ Ù…ØªÙˆØ³Ø· Ø§Ù„Ø³Ø±Ø¹Ø© (Ø·Ù†/Ø³Ø§Ø¹Ø©)
            const overallAvgSpeedTph = sessionDurationHours > 0 ? (totalPos / sessionDurationHours) : 0;
            
            // Ø§Ù„ÙƒØ§Ø¦Ù† Ø§Ù„Ø°ÙŠ Ø³ÙŠØªÙ… Ø­ÙØ¸Ù‡ ÙÙŠ Ø§Ù„Ø£Ø±Ø´ÙŠÙ (History)
            const report = {
                date: new Date().toISOString(),
                // **Ø§Ù„Ø­Ù‚Ù„ Ø§Ù„Ø°ÙŠ ÙƒÙ†Ø§ Ù†Ø¹Ù…Ù„ Ø¹Ù„ÙŠÙ‡:**
                userEmail: currentUser.email, 
                totalMoved: totalPos.toFixed(2),
                recordsCount: currentSession.length - 1, // Ø§Ø³ØªØ¨Ø¹Ø§Ø¯ Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ø¨Ø¯Ø¡
                avgSpeedTph: overallAvgSpeedTph.toFixed(2),
                data: currentSession.slice(1) // Ø­ÙØ¸ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù‚Ø±Ø§Ø¡Ø§Øª Ù…Ø§Ø¹Ø¯Ø§ Ø£ÙˆÙ„ Ù‚Ø±Ø§Ø¡Ø© ÙˆÙ‡Ù…ÙŠØ©
            };

            // 1. Ø­ÙØ¸ Ø§Ù„ØªÙ‚Ø±ÙŠØ± ÙÙŠ Ø§Ù„Ø£Ø±Ø´ÙŠÙ
            await db.ref(`molino_app_data/history/${currentUser.uid}/${Date.now()}`).set(report);
            
            // 2. Ù…Ø³Ø­ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¬Ù„Ø³Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©
            await db.ref(`molino_app_data/sessions/${currentUser.uid}`).remove();
            
            alert(`ØªÙ… Ø­ÙØ¸ ØªÙ‚Ø±ÙŠØ±Ùƒ Ø¨Ù†Ø¬Ø§Ø­. Ø§Ù„Ø¥Ù†ØªØ§Ø¬: ${report.totalMoved} Ø·Ù†.`);
            resetSessionState();
        }


        // --- UI & UTILITY FUNCTIONS ---

        function startTimer() {
            if (sessionTimerInterval) clearInterval(sessionTimerInterval);
            
            const timerEl = document.getElementById('session-timer');
            sessionTimerInterval = setInterval(() => {
                const elapsedMs = Date.now() - sessionStartTime;
                const hours = Math.floor(elapsedMs / 3600000);
                const minutes = Math.floor((elapsedMs % 3600000) / 60000);
                const seconds = Math.floor((elapsedMs % 60000) / 1000);

                const formattedTime = [hours, minutes, seconds]
                    .map(v => v < 10 ? "0" + v : v)
                    .join(':');

                timerEl.textContent = formattedTime;
            }, 1000);
        }

        function updateSummaryDisplay() {
            const displaySession = currentSession.slice(1); // Ø§Ø³ØªØ¨Ø¹Ø§Ø¯ Ù‚Ø±Ø§Ø¡Ø© START Ø§Ù„ÙˆÙ‡Ù…ÙŠØ©

            const totalPos = displaySession.reduce((acc, r) => acc + (parseFloat(r.diff) || 0), 0);
            const totalTrucks = displaySession.reduce((acc, r) => acc + (parseFloat(r.truck) || 0), 0);
            
            let avgSpeed = 0;
            if (sessionStartTime && displaySession.length > 0) {
                const sessionDurationHours = (Date.now() - sessionStartTime) / 3600000;
                avgSpeed = sessionDurationHours > 0 ? (totalPos / sessionDurationHours) : 0;
            }

            document.getElementById('total-moved').textContent = formatNumber(totalPos) + ' T';
            document.getElementById('readings-count').textContent = displaySession.length;
            document.getElementById('avg-speed').textContent = formatNumber(avgSpeed) + ' T/h';
            document.getElementById('total-trucks').textContent = formatNumber(totalTrucks) + ' T';

            const tbody = document.getElementById('readings-table-body');
            tbody.innerHTML = '';

            displaySession.reverse().forEach(record => {
                const time = new Date(record.ts).toLocaleTimeString('ar-EG', { hour: '2-digit', minute: '2-digit' });
                const row = `
                    <tr class="data-row">
                        <td class="p-3 font-mono" dir="ltr">${time}</td>
                        <td class="p-3">${record.silo}</td>
                        <td class="p-3" dir="ltr">${formatNumber(record.weight)}</td>
                        <td class="p-3 text-center font-bold ${record.diff > 0 ? 'text-green-600' : 'text-gray-400'}" dir="ltr">${formatNumber(record.diff)}</td>
                    </tr>
                `;
                tbody.innerHTML += row;
            });
            displaySession.reverse(); // Ù„Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ±ØªÙŠØ¨ Ø§Ù„Ø¯Ø§Ø®Ù„ÙŠ ØµØ­ÙŠØ­Ø§Ù‹
        }

        const formatNumber = (num) => {
            return new Intl.NumberFormat('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 }).format(num || 0);
        };
    </script>
</body>
</html>
